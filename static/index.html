<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>U Bible - Home</title>
    <script src="/js/settings.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 50%, #16213e 100%);
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(76, 175, 80, 0.6);
            border-radius: 50%;
            animation: particleFloat 15s infinite linear;
        }

        @keyframes particleFloat {
            0% {
                transform: translateY(100vh) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) translateX(100px);
                opacity: 0;
            }
        }

        .app-container {
            width: 95%;
            max-width: 1500px;
            height: 90vh;
            max-height: 850px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: grid;
            grid-template-rows: 80px 1fr 80px;
            overflow: hidden;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 10;
        }

        .header {
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            border-radius: 30px 30px 0 0;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            animation: logoGlow 2s ease-in-out infinite;
        }

        @keyframes logoGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(76, 175, 80, 0.3); }
            50% { box-shadow: 0 0 30px rgba(76, 175, 80, 0.6); }
        }

        .app-name h1 {
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .app-name p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85rem;
        }

        .header-stats {
            display: flex;
            gap: 30px;
        }

        .stat-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .stat-badge:hover {
            background: rgba(76, 175, 80, 0.2);
            transform: translateY(-2px);
        }

        .stat-badge-icon {
            font-size: 1.2rem;
        }

        .stat-badge-value {
            color: #4caf50;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .stat-badge-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
        }

        .content {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 30px 25px 20px;
            overflow: hidden;
        }

        .welcome-panel {
            text-align: center;
            max-width: 900px;
            width: 100%;
        }

        .welcome-title {
            color: white;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 12px;
            margin-top: 0;
            animation: fadeInUp 0.6s ease;
            line-height: 1.2;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .welcome-subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1rem;
            margin-bottom: 25px;
            animation: fadeInUp 0.8s ease;
            transition: all 1.5s ease;
            white-space: nowrap;
            line-height: 1.5;
            display: flex;
            align-items: baseline;
            justify-content: center;
            flex-wrap: wrap;
            gap: 0.2em;
        }

        /* Dynamic Word Animations */
        .dynamic-word {
            position: relative;
            display: inline-block;
            cursor: pointer;
            transition: all 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
            color: rgba(255, 255, 255, 0.75);
            min-width: 0;
            overflow: hidden;
            vertical-align: baseline;
            line-height: 1.5;
            margin: 0;
            padding: 0 2px;
            font-weight: 500;
        }

        .dynamic-word:hover {
            color: #4caf50;
            text-shadow: 0 0 8px rgba(76, 175, 80, 0.3);
            transform: scale(1.05);
        }

        .dynamic-word.changing {
            animation: wordChange 1.2s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        @keyframes wordChange {
            0% {
                transform: translateY(0) translateX(0) scale(1);
                opacity: 1;
                filter: blur(0px);
            }
            25% {
                transform: translateY(-3px) translateX(1px) scale(0.98);
                opacity: 0.4;
                filter: blur(1px);
            }
            50% {
                transform: translateY(-5px) translateX(2px) scale(0.95);
                opacity: 0;
                filter: blur(2px);
            }
            75% {
                transform: translateY(-3px) translateX(1px) scale(0.98);
                opacity: 0.4;
                filter: blur(1px);
            }
            100% {
                transform: translateY(0) translateX(0) scale(1);
                opacity: 1;
                filter: blur(0px);
            }
        }

        .search-container {
            max-width: 600px;
            margin: 0 auto 35px;
            animation: fadeInUp 0.9s ease;
        }

        .quick-play-button {
            width: 70px;
            height: 70px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.5);
            animation: pulse 2.5s ease-in-out infinite;
            border: 3px solid rgba(255, 255, 255, 0.2);
        }

        .quick-play-button:hover {
            transform: scale(1.15);
            box-shadow: 0 12px 35px rgba(76, 175, 80, 0.7);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .quick-play-button:active {
            transform: scale(0.95);
        }

        .quick-play-button svg {
            width: 32px;
            height: 32px;
            fill: white;
            margin-left: 4px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 8px 25px rgba(76, 175, 80, 0.5);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 12px 35px rgba(76, 175, 80, 0.8);
                transform: scale(1.05);
            }
        }

        .search-box {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input {
            width: 100%;
            padding: 16px 50px 16px 50px;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s;
            outline: none;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .search-input:focus {
            background: rgba(255, 255, 255, 0.12);
            border-color: #4ecdc4;
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.3);
        }

        .search-icon {
            position: absolute;
            left: 18px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 1.2rem;
            pointer-events: none;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 10px;
            background: linear-gradient(135deg, #2a3050 0%, #3a4570 100%);
            border: 2px solid rgba(78, 205, 196, 0.3);
            border-radius: 15px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .search-result-item {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .search-result-item:hover {
            background: rgba(78, 205, 196, 0.1);
        }

        .search-result-content {
            flex: 1;
            cursor: pointer;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-title {
            color: white;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .search-result-meta {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85rem;
        }

        .no-results {
            padding: 30px;
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
        }

        .save-to-bank-btn {
            padding: 8px 16px;
            background: rgba(78, 205, 196, 0.2);
            border: 2px solid rgba(78, 205, 196, 0.4);
            color: #4ecdc4;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .save-to-bank-btn:hover {
            background: rgba(78, 205, 196, 0.3);
            border-color: #4ecdc4;
            transform: scale(1.05);
        }

        .save-to-bank-btn:active {
            transform: scale(0.95);
        }

        .save-to-bank-btn.saved {
            background: rgba(76, 175, 80, 0.2);
            border-color: rgba(76, 175, 80, 0.4);
            color: #4caf50;
        }

        .save-to-bank-btn.remove {
            background: rgba(244, 67, 54, 0.2);
            border: 2px solid rgba(244, 67, 54, 0.4);
            color: #f44336;
        }

        .save-to-bank-btn.remove:hover {
            background: rgba(244, 67, 54, 0.3);
            border-color: #f44336;
            transform: scale(1.05);
        }

        .save-to-bank-btn.disabled {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 60px;
            animation: fadeInUp 1s ease;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .menu-card {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid transparent;
            border-radius: 15px;
            padding: 30px 15px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .menu-card.multiplayer {
            background: rgba(255, 106, 106, 0.03);
            border-color: rgba(255, 106, 106, 0.1);
        }

        .menu-card.multiplayer:hover {
            background: rgba(255, 106, 106, 0.08);
            border-color: #ff6b6b;
        }

        .menu-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(76, 175, 80, 0.3), transparent);
            transition: left 0.6s;
        }

        .menu-card.multiplayer::before {
            background: linear-gradient(90deg, transparent, rgba(255, 106, 106, 0.3), transparent);
        }

        .menu-card:hover::before {
            left: 100%;
        }

        .menu-card:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateY(-8px);
            border-color: #4caf50;
        }

        .menu-card:active {
            transform: translateY(-4px);
            transition: transform 0.1s;
        }

        .menu-icon {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            transition: all 0.3s;
        }

        .menu-card:hover .menu-icon {
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(10deg) scale(1.1);
        }

        .menu-title {
            color: white;
            font-size: 1rem;
            font-weight: 600;
        }

        .menu-description {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.75rem;
            text-align: center;
        }

        .new-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            animation: pulse 2s ease infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .quick-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            animation: fadeInUp 1.2s ease;
        }

        .btn {
            padding: 15px 40px;
            border-radius: 25px;
            border: none;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
            animation: btnGlow 2s ease-in-out infinite;
        }

        @keyframes btnGlow {
            0%, 100% { box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3); }
            50% { box-shadow: 0 8px 30px rgba(76, 175, 80, 0.5); }
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .footer {
            background: rgba(255, 255, 255, 0.05);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            border-radius: 0 0 30px 30px;
        }

        .footer-info {
            display: flex;
            gap: 30px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        .info-icon {
            color: #4caf50;
            font-size: 1rem;
        }

        .info-value {
            color: white;
            font-weight: 600;
        }

        .footer-actions {
            display: flex;
            gap: 10px;
        }

        .footer-link {
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 20px;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .footer-link:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .login-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
            cursor: pointer;
        }

        .login-modal-content {
            position: relative;
            background: linear-gradient(135deg, #2a3050 0%, #3a4570 100%);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            border: 2px solid rgba(76, 175, 80, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.8rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 300;
            line-height: 1;
            padding: 0;
        }

        .close-btn:hover {
            background: rgba(255, 106, 106, 0.2);
            border-color: #ff6b6b;
            color: #ff6b6b;
            transform: rotate(90deg) scale(1.1);
        }

        .close-btn:active {
            transform: rotate(90deg) scale(0.95);
        }

        .login-modal-content h2 {
            color: white;
            font-size: 2rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .login-subtitle {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            text-align: center;
            margin-bottom: 30px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .password-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .password-wrapper input {
            padding-right: 45px;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
            transition: color 0.3s;
        }

        .password-toggle:hover {
            color: rgba(255, 255, 255, 0.9);
        }

        .form-group input {
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 1rem;
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .form-group input:focus {
            outline: none;
            border-color: #4caf50;
            background: rgba(255, 255, 255, 0.15);
        }

        .login-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .guest-link {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            cursor: pointer;
            transition: color 0.3s;
            padding: 10px;
        }

        .guest-link:hover {
            color: white;
        }

        .multiplayer-menu-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .multiplayer-menu-content {
            background: linear-gradient(135deg, #2a3050 0%, #3a4570 100%);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            padding: 40px;
            text-align: center;
            border: 2px solid rgba(255, 107, 107, 0.3);
            min-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .multiplayer-menu-content h2 {
            color: white;
            font-size: 2rem;
            margin-bottom: 30px;
            font-weight: 700;
        }

        .multiplayer-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 30px 0;
        }

        .multiplayer-option-btn {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px 25px;
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.08) 0%, rgba(255, 107, 107, 0.04) 100%);
            border: 2px solid rgba(255, 107, 107, 0.2);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
        }

        .multiplayer-option-btn:hover {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.15) 0%, rgba(255, 107, 107, 0.08) 100%);
            border-color: #ff6b6b;
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
        }

        .multiplayer-option-btn:active {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.2);
        }

        .option-icon {
            font-size: 2.5rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.15) 0%, rgba(255, 107, 107, 0.08) 100%);
            border-radius: 12px;
            flex-shrink: 0;
        }

        .option-text {
            text-align: left;
            flex: 1;
        }

        .option-text h3 {
            color: white;
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .option-text p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        /* Modal Tabs */
        .modal-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .modal-tab {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: rgba(255, 255, 255, 0.5);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            bottom: -2px;
        }

        .modal-tab:hover {
            color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.05);
        }

        .modal-tab.active {
            color: white;
            border-bottom-color: #4caf50;
        }

        .modal-tab span {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-content {
            display: none !important;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: flex !important;
            flex-direction: column;
        }

        .multiplayer-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .multiplayer-modal-content {
            background: linear-gradient(135deg, #2a3050 0%, #3a4570 100%);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            padding: 40px;
            text-align: center;
            border: 2px solid rgba(255, 107, 107, 0.3);
            min-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .multiplayer-modal-content h2 {
            color: white;
            font-size: 2rem;
            margin-bottom: 30px;
            font-weight: 700;
        }

        .room-code-input {
            width: 100%;
            padding: 20px;
            font-size: 2rem;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            color: white;
            letter-spacing: 10px;
            margin: 20px 0;
            text-transform: uppercase;
        }

        .room-code-input:focus {
            outline: none;
            border-color: #ff6b6b;
            background: rgba(255, 255, 255, 0.15);
        }

        .room-code-display {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
        }

        .room-code-large {
            font-size: 3rem;
            font-weight: 700;
            color: #ff6b6b;
            letter-spacing: 15px;
            margin: 20px 0;
        }

        .copy-btn {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.5);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: rgba(76, 175, 80, 0.3);
            transform: translateY(-2px);
        }

        .players-in-room {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 30px 0;
        }

        .player-slot {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .player-status {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 700;
        }

        .player-status.ready {
            background: #4caf50;
            color: white;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .waiting-spinner {
            margin: 30px auto;
            position: relative;
            width: 80px;
            height: 80px;
        }

        .spinner {
            width: 80px;
            height: 80px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #ff6b6b;
            border-right-color: #ff6b6b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .multiplayer-modal-content p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
            margin: 20px 0;
        }

        /* Themes Modal */
        .themes-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .themes-modal-content {
            background: linear-gradient(135deg, #2a3050 0%, #3a4570 100%);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            min-width: 500px;
            max-width: 650px;
            max-height: 90vh;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }

        .themes-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .themes-modal-header h2 {
            color: white;
            font-size: 1.5rem;
            margin: 0;
        }

        .theme-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .theme-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(76, 175, 80, 0.5);
            transform: translateX(5px);
        }

        .theme-info {
            flex: 1;
        }

        .theme-name {
            color: white;
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .theme-meta {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
        }

        .theme-actions {
            display: flex;
            gap: 10px;
        }

        .theme-remove-btn {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.5);
            color: #ff6b6b;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .theme-remove-btn:hover {
            background: rgba(255, 107, 107, 0.3);
            transform: scale(1.05);
        }

        .theme-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .theme-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #4caf50;
        }

        .checkbox-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
        }

        .theme-selected {
            background: rgba(76, 175, 80, 0.1);
            border-color: rgba(76, 175, 80, 0.5);
        }

        .empty-themes {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.6);
        }

        .empty-themes-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .quick-start-summary {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-row:last-child {
            border-bottom: none;
        }

        .settings-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.95rem;
        }

        .settings-value {
            color: white;
            font-weight: 600;
            font-size: 1rem;
        }

        .start-quiz-btn {
            width: 100%;
            padding: 16px;
            font-size: 1.2rem;
            margin-top: 10px;
        }

        .match-found-notification {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            animation: fadeIn 0.3s ease;
        }

        .match-found-content {
            background: linear-gradient(135deg, #2a3050 0%, #3a4570 100%);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            padding: 50px;
            text-align: center;
            border: 3px solid #ff6b6b;
            box-shadow: 0 0 100px rgba(255, 107, 107, 0.5);
            animation: matchPulse 0.5s ease;
        }

        @keyframes matchPulse {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }

        .match-found-content h2 {
            color: white;
            font-size: 2.5rem;
            margin-bottom: 20px;
            font-weight: 700;
            animation: glow 2s ease-in-out infinite;
        }

        .match-found-content p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.2rem;
            margin: 10px 0;
        }

        @keyframes glow {
            0%, 100% { text-shadow: 0 0 20px rgba(255, 107, 107, 0.5); }
            50% { text-shadow: 0 0 40px rgba(255, 107, 107, 0.8); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 1200px) {
            .menu-grid {
                grid-template-columns: repeat(3, 1fr);
                max-width: 700px;
            }
        }

        @media (max-width: 900px) {
            .menu-grid {
                grid-template-columns: repeat(2, 1fr);
                max-width: 500px;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                grid-template-rows: 70px 1fr 70px;
            }

            .header-stats {
                display: none;
            }

            .menu-grid {
                grid-template-columns: 1fr;
                max-width: 300px;
            }

            .welcome-title {
                font-size: 2rem;
            }

            .quick-play-button {
                width: 60px;
                height: 60px;
                margin: 0 auto 18px;
            }

            .quick-play-button svg {
                width: 28px;
                height: 28px;
            }

            .quick-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .multiplayer-modal-content,
            .multiplayer-menu-content {
                min-width: 90%;
                padding: 30px 20px;
            }
            
            .match-found-content {
                padding: 30px 20px;
            }

            .login-modal-content {
                max-width: 90%;
            }
        }

        /* Custom scrollbar for themes list */
        #themesList::-webkit-scrollbar {
            width: 6px;
        }

        #themesList::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        #themesList::-webkit-scrollbar-thumb {
            background: rgba(76, 175, 80, 0.5);
            border-radius: 3px;
            transition: background 0.3s;
        }

        #themesList::-webkit-scrollbar-thumb:hover {
            background: rgba(76, 175, 80, 0.8);
        }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>

    <div class="login-modal" id="loginModal">
        <div class="login-modal-content">
            <h2>Welcome to U Bible</h2>
            <p class="login-subtitle">Sign in to track your progress and compete</p>
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="username" placeholder="Enter your username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" placeholder="Enter your password" required autocomplete="current-password">
                </div>
                <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                    <input type="checkbox" id="rememberMe" style="width: auto; height: 18px; cursor: pointer; margin: 0;">
                    <label for="rememberMe" style="margin: 0; cursor: pointer; user-select: none; color: rgba(255, 255, 255, 0.9); font-size: 0.95rem;">Remember my username</label>
                </div>
                <div class="login-actions">
                    <button type="submit" class="btn btn-primary">Login</button>
                    <button type="button" class="btn btn-secondary" onclick="showRegister()">Register</button>
                    <div class="guest-link" onclick="continueAsGuest()">Continue as Guest</div>
                </div>
            </form>
        </div>
    </div>

    <!-- Themes Modal -->
    <div class="themes-modal" id="themesModal" onclick="closeThemesModal(event)">
        <div class="themes-modal-content" onclick="event.stopPropagation()">
            <div class="themes-modal-header">
                <h2>📚 Selected Themes</h2>
                <button class="btn btn-secondary" onclick="closeThemesModal()">Close</button>
            </div>
            <div id="themesListContainer"></div>
        </div>
    </div>

    <!-- Quick Start Preview Modal -->
    <div class="themes-modal" id="quickStartModal" onclick="closeQuickStartModal(event)">
        <div class="themes-modal-content" onclick="event.stopPropagation()" style="width: 520px; height: 580px; max-height: 90vh; display: flex; flex-direction: column;">
            <div class="themes-modal-header">
                <h2>⚡ Quick Start</h2>
                <button class="btn btn-secondary" onclick="closeQuickStartModal()">Cancel</button>
            </div>

            <!-- Tab Navigation -->
            <div class="modal-tabs">
                <button class="modal-tab active" onclick="switchQuickStartTab('singleplayer')">
                    <span>🎮 Single Player</span>
                </button>
                <button class="modal-tab" onclick="switchQuickStartTab('multiplayer')">
                    <span>⚔️ Multiplayer</span>
                </button>
            </div>

            <!-- Single Player Tab -->
            <div id="singleplayerTab" class="tab-content active" style="flex: 1; display: flex; flex-direction: column;">
                <div id="quickStartContainer" style="flex: 1; overflow-y: auto; padding-bottom: 30px; margin-bottom: 20px;"></div>
                <div id="quickStartButtonContainer" style="padding: 15px 0; border-top: 1px solid rgba(255, 255, 255, 0.1); background: linear-gradient(180deg, rgba(42, 48, 80, 0.95) 0%, rgba(42, 48, 80, 1) 100%);"></div>
            </div>

            <!-- Multiplayer Tab -->
            <div id="multiplayerTab" class="tab-content" style="flex: 1; overflow-y: auto;">
                <!-- Main Menu -->
                <div id="multiplayerMainMenu" style="display: flex; flex-direction: column; gap: 15px; padding: 10px 0;">
                    <button class="multiplayer-option-btn" onclick="showMultiplayerView('searching')">
                        <div class="option-icon">⚡</div>
                        <div class="option-text">
                            <h3>Quick Match</h3>
                            <p>Find a random opponent</p>
                        </div>
                    </button>
                    <button class="multiplayer-option-btn" onclick="showMultiplayerView('createRoom')">
                        <div class="option-icon">🏠</div>
                        <div class="option-text">
                            <h3>Create Private Room</h3>
                            <p>Host a game with friends</p>
                        </div>
                    </button>
                    <button class="multiplayer-option-btn" onclick="showMultiplayerView('joinRoom')">
                        <div class="option-icon">🔑</div>
                        <div class="option-text">
                            <h3>Join Private Room</h3>
                            <p>Enter a 6-character code</p>
                        </div>
                    </button>
                </div>

                <!-- Searching View -->
                <div id="multiplayerSearching" style="display: none; text-align: center; padding: 40px 20px;">
                    <div class="spinner" style="margin: 0 auto 20px;"></div>
                    <h3 style="color: white; margin-bottom: 10px;">🔍 Finding Opponent...</h3>
                    <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 20px;">Searching for a player with similar settings</p>
                    <button class="btn btn-secondary" onclick="showMultiplayerView('main'); multiplayerManager.cancelSearch();">Cancel Search</button>
                </div>

                <!-- Create Room View -->
                <div id="multiplayerCreateRoom" style="display: none; padding: 10px 0;">
                    <h3 style="color: white; margin-bottom: 15px; text-align: center;">🏠 Create Private Room</h3>

                    <div style="margin-bottom: 20px; padding: 15px; background: rgba(78, 205, 196, 0.1); border-radius: 10px; border: 1px solid rgba(78, 205, 196, 0.3);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                            <span style="font-size: 1.3rem;">👥</span>
                            <span style="font-weight: 600; color: white; font-size: 0.95rem;">Room holds up to 10 players</span>
                        </div>
                        <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.8rem; margin: 0;">
                            Start with 2+ players • More can join before you start
                        </p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="color: white; font-weight: 600; margin-bottom: 10px; display: block; font-size: 0.95rem;">
                            📚 Room Themes <span id="themeSelectionCount" style="color: rgba(255,255,255,0.6); font-weight: normal; font-size: 0.85rem;">(0/5 selected)</span>
                        </label>
                        <div id="themeSelector" style="max-height: 150px; overflow-y: auto; padding: 8px; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 10px;">
                            <div style="color: rgba(255,255,255,0.6); padding: 20px; text-align: center; font-size: 0.85rem;">Loading themes...</div>
                        </div>
                        <p style="color: rgba(255, 255, 255, 0.6); font-size: 0.75rem; margin-top: 6px;">
                            Select up to 5 themes • Only your configured themes
                        </p>
                    </div>

                    <div style="margin-bottom: 25px; padding: 12px; background: rgba(76, 175, 80, 0.1); border-radius: 10px; border: 1px solid rgba(76, 175, 80, 0.3);">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                            <input type="checkbox" id="hostPlayingCheckbox" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <div>
                                <div style="font-weight: 600; color: white; font-size: 0.9rem;">I'm playing in this game</div>
                                <div style="color: rgba(255, 255, 255, 0.7); font-size: 0.75rem;">Uncheck to spectate only</div>
                            </div>
                        </label>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" style="flex: 1;" onclick="showMultiplayerView('main')">Back</button>
                        <button class="btn btn-primary" style="flex: 1;" onclick="confirmCreateRoomIntegrated()">Create Room</button>
                    </div>
                </div>

                <!-- Join Room View -->
                <div id="multiplayerJoinRoom" style="display: none; text-align: center; padding: 20px 0;">
                    <h3 style="color: white; margin-bottom: 10px;">🔑 Join Private Room</h3>
                    <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 20px; font-size: 0.9rem;">Enter the 6-character room code</p>
                    <input type="text"
                           id="roomCodeInputIntegrated"
                           class="room-code-input"
                           placeholder="ABC123"
                           maxlength="6"
                           style="width: 100%; margin-bottom: 20px;"
                           oninput="this.value=this.value.toUpperCase()"
                           onkeypress="if(event.key==='Enter') joinRoomIntegrated()">
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" style="flex: 1;" onclick="showMultiplayerView('main')">Back</button>
                        <button class="btn btn-primary" style="flex: 1;" onclick="joinRoomIntegrated()">Join Room</button>
                    </div>
                </div>

                <!-- Waiting Room View -->
                <div id="multiplayerWaitingRoom" style="display: none; padding: 10px 0; flex-direction: column; height: 100%;">
                    <h3 id="waitingRoomTitle" style="color: white; margin-bottom: 15px; text-align: center;">🏠 Private Room</h3>

                    <div class="room-code-display" style="text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 10px; border: 1px solid rgba(76, 175, 80, 0.3);">
                        <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.85rem; margin-bottom: 8px;">Room Code:</p>
                        <div id="displayRoomCodeIntegrated" style="font-size: 2rem; font-weight: bold; color: #4caf50; letter-spacing: 4px; margin-bottom: 10px;">------</div>
                        <button class="btn btn-secondary" style="font-size: 0.85rem; padding: 8px 16px;" onclick="copyRoomCodeIntegrated()">📋 Copy Code</button>
                    </div>

                    <div id="spectatingNotice" style="display: none; padding: 12px; background: rgba(255, 193, 7, 0.1); border-radius: 10px; border: 1px solid rgba(255, 193, 7, 0.3); margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px; color: #ffc107;">
                            <span style="font-size: 1.2rem;">👁️</span>
                            <span style="font-weight: 600; font-size: 0.9rem;">Spectating Mode</span>
                        </div>
                        <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.75rem; margin: 5px 0 0 0;">
                            You're watching this game, not playing
                        </p>
                    </div>

                    <div id="playersContainerIntegrated" style="flex: 1; overflow-y: auto; margin-bottom: 15px; padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 10px; min-height: 120px;">
                        <!-- Players will be dynamically updated -->
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button id="readyBtnIntegrated" class="btn btn-primary" onclick="toggleReadyIntegrated()">Ready</button>
                        <button class="btn btn-secondary" onclick="leaveRoomIntegrated()">Leave Room</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <div class="header">
            <div class="logo-area">
                <div class="logo">📖</div>
                <div class="app-name">
                    <h1>U Bible</h1>
                    <p>Interactive Scripture Learning</p>
                </div>
            </div>
            
            <div class="header-stats">
                <div class="stat-badge" id="userBadge" onclick="openUserModal()" style="cursor: pointer;">
                    <span class="stat-badge-icon">👤</span>
                    <div>
                        <div class="stat-badge-value" id="playerNameDisplay">Guest</div>
                        <div class="stat-badge-label">Player</div>
                    </div>
                </div>
                <div class="stat-badge">
                    <span class="stat-badge-icon">🏆</span>
                    <div>
                        <div class="stat-badge-value" id="rank">--</div>
                        <div class="stat-badge-label">Rank</div>
                    </div>
                </div>
                <div class="stat-badge" onclick="openThemesModal()" style="cursor: pointer;">
                    <span class="stat-badge-icon">📚</span>
                    <div>
                        <div class="stat-badge-value" id="themeCount">0</div>
                        <div class="stat-badge-label">Themes</div>
                    </div>
                </div>
                <div class="stat-badge">
                    <span class="stat-badge-icon">📖</span>
                    <div>
                        <div class="stat-badge-value" id="verseCount">0</div>
                        <div class="stat-badge-label">Verses</div>
                    </div>
                </div>
                <div class="stat-badge">
                    <span class="stat-badge-icon">✨</span>
                    <div>
                        <div class="stat-badge-value" id="bestScore">--</div>
                        <div class="stat-badge-label">Best</div>
                    </div>
                </div>
                <div class="stat-badge" onclick="window.location.href='/debugger.html'" style="cursor: pointer; background: rgba(76, 175, 80, 0.15); border: 1px solid rgba(76, 175, 80, 0.3);">
                    <span class="stat-badge-icon">🔧</span>
                    <div>
                        <div class="stat-badge-value">Debug</div>
                        <div class="stat-badge-label">Tools</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="content">
            <div class="welcome-panel">
                <h1 class="welcome-title">Welcome to U Bible</h1>
                <p class="welcome-subtitle">
                    <span class="dynamic-word" data-words="Master,Learn,Study,Explore,Discover">Master</span> 
                    <span class="dynamic-word" data-words="scripture,God's Word,the Bible,His truth,divine wisdom">scripture</span> 
                    through 
                    <span class="dynamic-word" data-words="interactive,engaging,exciting,powerful,transformative">interactive</span> 
                    <span class="dynamic-word" data-words="practice sessions,learning,study,memorization,meditation">practice sessions</span>
                </p>

                <div class="search-container">
                    <div class="quick-play-button" onclick="quickStart()" title="Quick Start - Jump right in!">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                    </div>
                    <div class="search-box">
                        <span class="search-icon">🔍</span>
                        <input type="text"
                               class="search-input"
                               id="themeSearch"
                               placeholder="Search themes..."
                               oninput="searchThemes(this.value)"
                               onfocus="document.getElementById('searchResults').style.display = 'block'"
                               autocomplete="off">
                        <div class="search-results" id="searchResults"></div>
                    </div>
                </div>

                <div class="menu-grid">
                    <div class="menu-card" onclick="viewChallenges()">
                     <div class="menu-icon">🎯</div>
                     <div class="menu-title">Challenges</div>
                     <div class="menu-description">Beat friend scores</div>
                    </div>

                    <div class="menu-card" onclick="location.href='/practice.html'">
                        <div class="menu-icon">📚</div>
                        <div class="menu-title">Practice</div>
                        <div class="menu-description">Study themes</div>
                    </div>

                    <div class="menu-card" onclick="location.href='/teams.html'">
                        <span class="new-badge">New!</span>
                        <div class="menu-icon">👥</div>
                        <div class="menu-title">Team Portal</div>
                        <div class="menu-description">Join or create teams</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <div class="footer-info">
                <div class="info-item">
                    <span class="info-icon">📊</span>
                    <span>Version <span class="info-value">2.0.0</span></span>
                </div>
                <div class="info-item">
                    <span class="info-icon">⏰</span>
                    <span>Last played: <span class="info-value" id="lastPlayed">Never</span></span>
                </div>
                <div class="info-item">
                    <span class="info-icon">🌐</span>
                    <span>Players online: <span class="info-value" id="playersOnline">--</span></span>
                </div>
            </div>
            
            <div class="footer-actions">
                <a href="#" class="footer-link" id="loginLink" onclick="openLoginModal(); return false;">Login</a>
                <a href="#" class="footer-link" id="logoutLink" onclick="logout(); return false;" style="display: none;">Logout</a>
                <a href="#" class="footer-link" onclick="showHelp(); return false;">Help</a>
                <a href="#" class="footer-link" onclick="showAbout(); return false;">About</a>
                <a href="#" class="footer-link" onclick="resetData(); return false;">Reset Data</a>
            </div>
        </div>
    </div>

    <script>
        // Suppress browser extension errors
        window.addEventListener('error', (e) => {
            if (e.message && e.message.includes('message channel closed')) {
                e.preventDefault();
                e.stopPropagation();
                return true;
            }
        });

        window.addEventListener('unhandledrejection', (e) => {
            if (e.reason && e.reason.message && e.reason.message.includes('message channel closed')) {
                e.preventDefault();
                e.stopPropagation();
                return true;
            }
        });

        // Note: loadStats() function is defined later in the file (line ~3005)
        // It loads: rank, themes, verses, online players, last played, best score

        // ==============================
        // Dynamic Word Animations
        // ==============================
        document.addEventListener('DOMContentLoaded', function() {
            const dynamicWords = document.querySelectorAll('.dynamic-word');
            
            dynamicWords.forEach(word => {
                const words = word.getAttribute('data-words').split(',');
                let currentIndex = 0;
                
                // Add click event to change word
                word.addEventListener('click', function() {
                    if (this.classList.contains('changing')) return;
                    
                    this.classList.add('changing');
                    currentIndex = (currentIndex + 1) % words.length;
                    
                    // Store current width for smooth transition
                    const currentWidth = this.offsetWidth;
                    this.style.width = currentWidth + 'px';
                    this.style.transition = 'width 0.6s cubic-bezier(0.4, 0.0, 0.2, 1)';

                    // Change the word at the midpoint of the animation for smoother transition
                    setTimeout(() => {
                        this.textContent = words[currentIndex];
                        // Allow width to adjust naturally with smooth transition
                        this.style.width = 'auto';
                    }, 600);

                    // Remove the changing class after animation completes
                    setTimeout(() => {
                        this.classList.remove('changing');
                        this.style.transition = 'all 0.6s cubic-bezier(0.4, 0.0, 0.2, 1)';
                    }, 1200);
                });
                
                // Auto-rotate words every 10 seconds
                setInterval(() => {
                    if (Math.random() < 0.15) { // 15% chance to change
                        word.click();
                    }
                }, 10000);
            });
        });

        // ==============================
        // Themes Modal
        // ==============================
        async function openThemesModal() {
            const modal = document.getElementById('themesModal');
            modal.style.display = 'flex';
            await loadSelectedThemes();
        }

        function closeThemesModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('themesModal');
            modal.style.display = 'none';
        }

        async function loadSelectedThemes() {
            const container = document.getElementById('themesListContainer');
            const selectedThemeIds = JSON.parse(localStorage.getItem('selectedThemes') || '[]');
            const questionType = localStorage.getItem('questionType') || 'reference';

            try {
                const response = await fetch('/api/themes');
                const data = await response.json();

                if (!data.success || !data.themes) {
                    throw new Error('Failed to load themes');
                }

                const allThemes = data.themes;

                if (allThemes.length === 0) {
                    container.innerHTML = `
                        <div class="empty-themes">
                            <div class="empty-themes-icon">📚</div>
                            <h3>No Themes Available</h3>
                            <p>No themes found in the system</p>
                        </div>
                    `;
                    return;
                }

                // Show all themes with checkboxes
                const themesHTML = allThemes.map(theme => {
                    const isSelected = selectedThemeIds.includes(theme.id);
                    return `
                        <div class="theme-item ${isSelected ? 'theme-selected' : ''}" data-theme-id="${theme.id}">
                            <div class="theme-info">
                                <div class="theme-name">${theme.name}</div>
                                <div class="theme-meta">${theme.question_count || 0} questions</div>
                            </div>
                            <div class="theme-actions">
                                <label class="theme-checkbox">
                                    <input type="checkbox"
                                           ${isSelected ? 'checked' : ''}
                                           onchange="toggleTheme(${theme.id}, this.checked)">
                                    <span class="checkbox-label">${isSelected ? 'Selected' : 'Select'}</span>
                                </label>
                            </div>
                        </div>
                    `;
                }).join('');

                const selectedCount = selectedThemeIds.length;
                container.innerHTML = `
                    <div style="background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 10px; padding: 12px; margin-bottom: 15px;">
                        <strong style="color: #4caf50;">Selected: ${selectedCount} theme${selectedCount !== 1 ? 's' : ''}</strong>
                        <p style="color: rgba(255, 255, 255, 0.7); margin: 5px 0 0 0; font-size: 0.85rem;">Check/uncheck themes to add or remove them</p>
                    </div>

                    <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 12px; margin-bottom: 15px;">
                        <strong style="color: white; display: block; margin-bottom: 8px; font-size: 0.9rem;">Question Type:</strong>
                        <div style="position: relative; background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.2)); border-radius: 20px; padding: 3px; display: grid; grid-template-columns: 1fr 1fr 1fr; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);">
                            <div data-toggle-slider style="position: absolute; top: 3px; bottom: 3px; width: calc(33.333% - 2px); background: linear-gradient(135deg, #4caf50, #66bb6a); border-radius: 17px; transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), filter 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); transform: translateX(${questionType === 'both' ? '100%' : questionType === 'completion' ? '200%' : '0%'}); box-shadow: 0 4px 12px rgba(76, 175, 80, 0.6), 0 0 20px rgba(76, 175, 80, 0.3); filter: brightness(1.1);"></div>
                            <button data-toggle-type="reference" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(${questionType === 'reference' ? '1' : '0.95'})'" onclick="setQuestionType('reference');" style="position: relative; z-index: 1; padding: 8px; background: transparent; border: none; color: ${questionType === 'reference' ? 'white' : 'rgba(255, 255, 255, 0.5)'}; font-size: 0.85rem; font-weight: ${questionType === 'reference' ? '600' : '400'}; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); transform: scale(${questionType === 'reference' ? '1' : '0.95'});">
                                R→V
                            </button>
                            <button data-toggle-type="both" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(${questionType === 'both' ? '1' : '0.95'})'" onclick="setQuestionType('both');" style="position: relative; z-index: 1; padding: 8px; background: transparent; border: none; color: ${questionType === 'both' ? 'white' : 'rgba(255, 255, 255, 0.5)'}; font-size: 0.85rem; font-weight: ${questionType === 'both' ? '600' : '400'}; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); transform: scale(${questionType === 'both' ? '1' : '0.95'});">
                                Both
                            </button>
                            <button data-toggle-type="completion" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(${questionType === 'completion' ? '1' : '0.95'})'" onclick="setQuestionType('completion');" style="position: relative; z-index: 1; padding: 8px; background: transparent; border: none; color: ${questionType === 'completion' ? 'white' : 'rgba(255, 255, 255, 0.5)'}; font-size: 0.85rem; font-weight: ${questionType === 'completion' ? '600' : '400'}; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); transform: scale(${questionType === 'completion' ? '1' : '0.95'});">
                                V→R
                            </button>
                        </div>
                    </div>

                    <div style="max-height: 300px; overflow-y: auto;">
                        ${themesHTML}
                    </div>
                `;

            } catch (error) {
                console.error('Error loading themes:', error);
                container.innerHTML = `
                    <div class="empty-themes">
                        <div class="empty-themes-icon">❌</div>
                        <h3>Error Loading Themes</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="loadSelectedThemes()">Retry</button>
                    </div>
                `;
            }
        }

        function toggleTheme(themeId, isChecked) {
            const selectedThemes = JSON.parse(localStorage.getItem('selectedThemes') || '[]');

            if (isChecked) {
                // Add theme if not already selected
                if (!selectedThemes.includes(themeId)) {
                    selectedThemes.push(themeId);
                    console.log(`✅ Theme ${themeId} added to bank`);
                }
            } else {
                // Remove theme
                const index = selectedThemes.indexOf(themeId);
                if (index > -1) {
                    selectedThemes.splice(index, 1);
                    console.log(`❌ Theme ${themeId} removed from bank`);
                }
            }

            // Save to localStorage AND database
            SettingsManager.saveThemes(selectedThemes);

            // Update theme count badge
            document.getElementById('themeCount').textContent = selectedThemes.length;

            // Reload the themes list to update selected count
            loadSelectedThemes();
        }

        function setQuestionType(type) {
            localStorage.setItem('questionType', type);
            console.log(`✅ Question type set to: ${type}`);

            // Update all toggles on the page without reloading
            updateToggleVisuals(type);
        }

        function updateToggleVisuals(questionType) {
            // Find all toggle sliders and update their position
            const sliders = document.querySelectorAll('[data-toggle-slider]');
            sliders.forEach(slider => {
                const translateValue = questionType === 'both' ? '100%' : questionType === 'completion' ? '200%' : '0%';
                slider.style.transform = `translateX(${translateValue})`;
            });

            // Update all toggle buttons
            const buttons = document.querySelectorAll('[data-toggle-type]');
            buttons.forEach(button => {
                const buttonType = button.getAttribute('data-toggle-type');
                const isActive = buttonType === questionType;

                // Update color
                button.style.color = isActive ? 'white' : 'rgba(255, 255, 255, 0.5)';
                // Update font weight
                button.style.fontWeight = isActive ? '600' : '400';
                // Update scale
                button.style.transform = `scale(${isActive ? '1' : '0.95'})`;
                // Update hover handler
                button.onmouseout = () => {
                    button.style.transform = `scale(${isActive ? '1' : '0.95'})`;
                };
            });
        }

        // ==============================
        // User Profile Modal
        // ==============================
        const userModalHTML = `
            <div id="userProfileModal" class="login-modal" style="display: none;">
                <div class="login-modal-content" style="max-width: 400px;">
                    <button class="close-btn" onclick="closeUserModal()">×</button>
                    <h2 style="margin-bottom: 20px;">👤 Account</h2>

                    <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 20px;">
                        <div style="font-size: 3rem; margin-bottom: 10px;">👤</div>
                        <div style="color: #4ecdc4; font-weight: 600; font-size: 1.3rem;" id="modalUsername">@Guest</div>
                        <div style="color: rgba(255,255,255,0.6); font-size: 0.9rem; margin-top: 5px;" id="modalEmail">Not logged in</div>
                    </div>

                    <div id="modalAccountInfo" style="display: none;">
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 8px;">
                            <span style="color: rgba(255,255,255,0.7);">📊 Level:</span>
                            <span style="color: white; font-weight: 600;" id="modalLevel">1</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 8px;">
                            <span style="color: rgba(255,255,255,0.7);">🎮 Games Played:</span>
                            <span style="color: white; font-weight: 600;" id="modalGames">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 20px;">
                            <span style="color: rgba(255,255,255,0.7);">🏆 Win Rate:</span>
                            <span style="color: white; font-weight: 600;" id="modalWinRate">0%</span>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button id="modalLoginBtn" onclick="closeUserModal(); openLoginModal();" class="btn btn-primary" style="flex: 1;">
                            🔐 Login / Register
                        </button>
                        <button id="modalLogoutBtn" onclick="logout(); closeUserModal();" class="btn btn-secondary" style="flex: 1; display: none;">
                            🚪 Logout
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', userModalHTML);

        function openUserModal() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const playerName = localStorage.getItem('playerName');
            const isGuest = localStorage.getItem('isGuest') === 'true';

            // Update username
            document.getElementById('modalUsername').textContent = '@' + (playerName || 'Guest');

            // Update email
            if (user.email) {
                document.getElementById('modalEmail').textContent = user.email;
            } else {
                document.getElementById('modalEmail').textContent = isGuest ? 'Guest User' : 'Not logged in';
            }

            // Show/hide elements
            const loginBtn = document.getElementById('modalLoginBtn');
            const logoutBtn = document.getElementById('modalLogoutBtn');
            const accountInfo = document.getElementById('modalAccountInfo');

            if (playerName && !isGuest) {
                // Logged in user
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
                accountInfo.style.display = 'block';

                // Update account info
                document.getElementById('modalLevel').textContent = user.level || 1;
                document.getElementById('modalGames').textContent = user.total_games || 0;
                const winRate = user.total_games > 0 ? ((user.wins || 0) / user.total_games * 100).toFixed(1) : 0;
                document.getElementById('modalWinRate').textContent = winRate + '%';
            } else {
                // Guest or not logged in
                loginBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
                accountInfo.style.display = 'none';
            }

            document.getElementById('userProfileModal').style.display = 'flex';
        }

        function closeUserModal() {
            document.getElementById('userProfileModal').style.display = 'none';
        }

        // Click outside modal to close
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('userProfileModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeUserModal();
                    }
                });
            }
        });

        // ==============================
        // Toast notifications
        // ==============================
        function showSuccess(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                background: #4caf50;
                color: white;
                padding: 15px 30px;
                border-radius: 25px;
                z-index: 10000;
                animation: slideUp 0.3s ease;
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // 🧹 Helper function to clean up multiplayer state
        function clearMultiplayerState() {
            console.log('🧹 Clearing multiplayer state from localStorage...');
            localStorage.removeItem('multiplayerGame');
            localStorage.removeItem('currentRoomCode');
            localStorage.removeItem('currentGameURL');
            localStorage.removeItem('playerId');
            console.log('✅ Multiplayer state cleared');
        }

        function showError(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                background: #f44336;
                color: white;
                padding: 15px 30px;
                border-radius: 25px;
                z-index: 10000;
                animation: slideUp 0.3s ease;
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function showModal(title, content) {
            const modalHTML = `
                <div id="infoModal" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
                    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 30px; border-radius: 20px; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.5); color: white;">
                        <h2 style="margin: 0 0 20px 0; color: #4ecdc4; font-size: 24px;">${title}</h2>
                        <div style="line-height: 1.8; color: rgba(255,255,255,0.9); white-space: pre-wrap;">${content}</div>
                        <button onclick="closeInfoModal()" style="margin-top: 25px; padding: 12px 30px; background: #4ecdc4; color: white; border: none; border-radius: 25px; cursor: pointer; font-size: 16px; font-weight: bold;">Close</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeInfoModal() {
            const modal = document.getElementById('infoModal');
            if (modal) modal.remove();
        }

        // ==============================
        // Multiplayer Manager (single source of truth)
        // ==============================
        class MultiplayerManager {
            constructor() {
                this.ws = null;
                this.currentGame = null;
                this.currentRoomCode = null;
                this.currentGameURL = null; // Chess.com-style unique game URL
                this.isHost = false;
                this.isConnected = false;
                this.hostIsPlaying = true;
                this.matchOverlayShown = false;
                this.showMenuTimeout = null; // Debounce timer

                let storedPlayerId = localStorage.getItem('playerId');
                if (!storedPlayerId) {
                    storedPlayerId = 'player_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
                    localStorage.setItem('playerId', storedPlayerId);
                }
                this.playerId = storedPlayerId;

                this.playerName = localStorage.getItem('playerName') || ('Player' + Math.floor(Math.random() * 1000));
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectTimeout = null;
            }

            connect() {
                if (this.isConnected) return;
                try {
                    console.log('[MultiplayerManager] Connecting to WebSocket...');
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    // Use port 4000 for localhost, otherwise use same host (production will handle routing)
                    const wsHost = window.location.hostname === 'localhost' ? 'localhost:4000' : window.location.host;
                    const wsUrl = `${protocol}//${wsHost}/ws?player_id=${this.playerId}&username=${encodeURIComponent(this.playerName)}`;
                    this.ws = new WebSocket(wsUrl);
                    this.setupEventHandlers();
                } catch (error) {
                    console.error('[MultiplayerManager] Failed to connect:', error);
                    showError('Connection failed. Please refresh the page.');
                }
            }

            // NEW: Wait for WebSocket to be fully connected
            ensureConnected() {
                return new Promise((resolve, reject) => {
                    // Already connected
                    if (this.isConnected && this.ws && this.ws.readyState === WebSocket.OPEN) {
                        console.log('[MultiplayerManager] Already connected');
                        resolve();
                        return;
                    }

                    console.log('[MultiplayerManager] Waiting for connection...');

                    // Start connection if not started
                    if (!this.ws || this.ws.readyState === WebSocket.CLOSED) {
                        this.connect();
                    }

                    // Poll for connection with timeout
                    const checkInterval = setInterval(() => {
                        if (this.isConnected && this.ws.readyState === WebSocket.OPEN) {
                            clearInterval(checkInterval);
                            clearTimeout(timeout);
                            console.log('[MultiplayerManager] ✅ Connection established');
                            resolve();
                        }
                    }, 50);

                    const timeout = setTimeout(() => {
                        clearInterval(checkInterval);
                        console.error('[MultiplayerManager] ❌ Connection timeout');
                        reject(new Error('Connection timeout after 5 seconds'));
                        showError('Could not connect to server. Please refresh the page.');
                    }, 5000);
                });
            }

            setupEventHandlers() {
                this.ws.onopen = () => {
                    this.isConnected = true;
                    this.reconnectAttempts = 0;
                };

                this.ws.onclose = () => {
                    this.isConnected = false;
                    this.attemptReconnect();
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };

                this.ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        this.handleMessage(message);
                    } catch (error) {
                        console.error('Failed to parse message:', error);
                    }
                };
            }

        handleMessage(message) {
            const payload = typeof message.payload === 'string'
                ? (message.payload ? JSON.parse(message.payload) : {})
                : (message.payload || {});

            // Log all incoming messages for debugging
            console.log(`[MultiplayerManager] <- ${message.type}:`, payload);

            switch (message.type) {
                case 'connected':
                    console.log('[MultiplayerManager] ✅ WebSocket connection confirmed by server');
                    break;

                case 'searching':
                    this.showSearchingModal();
                    break;

                case 'match_found':
                    this.handleMatchFound(payload);
                    break;

                case 'room_created':
                    this.currentRoomCode = payload.room_code;
                    this.currentGameURL = payload.game_url; // Save game URL
                    console.log('[MultiplayerManager] ✅ Room created:', payload.room_code, 'Game URL:', payload.game_url);
                    this.isHost = true;
                    this.syncHostPlaying(payload.players);
                    showIntegratedWaitingRoom(payload.room_code, true);
                    setTimeout(() => {
                        updateIntegratedPlayerList(payload);
                    }, 100);
                    break;

                case 'room_joined':
                    console.log('[MultiplayerManager] ✅ Room joined successfully:', payload.room_code);

                    // Save host's theme settings to localStorage for joiners
                    if (payload.selected_themes && payload.selected_themes.length > 0) {
                        localStorage.setItem('selectedThemes', JSON.stringify(payload.selected_themes));
                        localStorage.setItem('quizSettings', JSON.stringify({
                            questionCount: payload.question_count || 10,
                            timeLimit: payload.time_limit || 10
                        }));
                        console.log('[MultiplayerManager] Saved host themes:', payload.selected_themes);
                    }
                    this.currentGameURL = payload.game_url; // Save game URL
                    console.log('[MultiplayerManager] Game URL:', payload.game_url);
                    this.syncHostPlaying(payload.players);
                    showIntegratedWaitingRoom(payload.room_code, false);
                    setTimeout(() => {
                        updateIntegratedPlayerList(payload);
                    }, 100);
                    break;

                case 'player_joined':
                    this.syncHostPlaying(payload.players);
                    updateIntegratedPlayerList(payload);
                    break;

                case 'room_update':
                    this.syncHostPlaying(payload.players);
                    updateIntegratedPlayerList(payload);
                    break;

                case 'player_ready_update':
                    this.syncHostPlaying(payload.players);
                    updateIntegratedPlayerList(payload);
                    break;

                case 'game_start':
                    this.currentGame = payload;
                    console.log('🎮 game_start received:', payload);

                    // Save multiplayer game data with all possible variations
                    const gameData = {
                        gameId: payload.game_id || payload.gameId || 'multiplayer-session',
                        game_id: payload.game_id || payload.gameId,
                        questions: payload.questions || [],
                        players: payload.players || [],
                        isMultiplayer: true,
                        room_code: payload.room_code || this.currentRoomCode,
                        roomCode: payload.room_code || this.currentRoomCode
                    };

                    console.log('💾 Saving to localStorage:', gameData);
                    localStorage.setItem('multiplayerGame', JSON.stringify(gameData));

                    // Verify it was saved
                    const saved = localStorage.getItem('multiplayerGame');
                    console.log('✅ Verified saved data:', JSON.parse(saved));

                    // Get player ID for the unique game URL
                    const playerId = localStorage.getItem('playerId') || this.playerId;

                    // Navigate to unique Chess.com-style game URL
                    const gameURL = this.currentGameURL || '/quiz.html';
                    const fullURL = playerId ? `${gameURL}?player_id=${playerId}` : gameURL;

                    console.log('🔗 Navigating to unique game URL:', fullURL);

                    this.closeAllModals();
                    this.showMatchFoundNotification();
                    setTimeout(() => { window.location.href = fullURL; }, 1200);
                    break;

                case 'error':
                    console.error('[MultiplayerManager] ❌ Server error:', payload.error || message.error);
                    showError(payload.error || message.error || 'An error occurred');
                    break;

                case 'ping':
                    this.send('pong', {});
                    break;

                default:
                    break;
            }
        }

            send(type, payload) {
                if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
                    console.warn(`[MultiplayerManager] ⚠️  Cannot send ${type} - WebSocket not ready (state: ${this.ws?.readyState})`);
                    showError('Connection not ready. Please wait...');
                    return false;
                }
                // IMPORTANT: send payload as an object (not a string) to match Go server expectations
                console.log(`[MultiplayerManager] -> ${type}:`, payload || {});
                this.ws.send(JSON.stringify({ type, payload: payload || {} }));
                return true;
            }

            quickMatch() {
                // Close menu first to avoid stacking modals
                this.closeMenu();
                this.showSearchingModal();
                if (!this.isConnected) {
                    this.connect();
                    setTimeout(() => this.findMatch(), 200);
                    return;
                }
                this.findMatch();
            }

findMatch() {
    if (!this.isConnected) {
        this.connect();
        setTimeout(() => this.findMatch(), 300);
        return;
    }
    // Get selected themes from localStorage (array of theme IDs)
    const selectedThemes = JSON.parse(localStorage.getItem('selectedThemes') || '[]');

    if (selectedThemes.length === 0) {
        showError('Please select themes using Quick Start before playing multiplayer');
        this.closeAllModals();
        setTimeout(() => this.showMenu(), 10);
        return;
    }

    // ✅ FIXED: Standardized multiplayer settings
    // - 10 seconds per question (fast-paced competitive play)
    // - 20 questions (substantial game length)
    // This ensures all players match with the same settings
    // Increases matchmaking pool and reduces wait times
    this.send('find_match', {
        selected_themes: selectedThemes, // Now sends theme IDs
        question_count: 20,  // ← Always 20 questions
        time_limit: 10       // ← Always 10 seconds per question
    });
}

            createPrivateRoom() {
                if (!this.isConnected) {
                    this.connect();
                    setTimeout(() => this.createPrivateRoom(), 300);
                    return;
                }

                this.showRoomSettingsModal();
            }

            showRoomSettingsModal() {
                this.closeMenu();
                if (document.getElementById('roomSettingsModal')) return;

                const settingsHTML = `
                    <div id="roomSettingsModal" class="multiplayer-modal">
                        <div class="multiplayer-modal-content">
                            <h2>🏠 Create Private Room</h2>
                            <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 25px;">
                                Configure your game settings
                            </p>

                            <div class="room-settings-form">
                                <div class="setting-group" style="margin-bottom: 20px; padding: 15px; background: rgba(78, 205, 196, 0.1); border-radius: 10px; border: 1px solid rgba(78, 205, 196, 0.3);">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                        <span style="font-size: 1.3rem;">👥</span>
                                        <span style="font-weight: 600; color: white;">Room holds up to 10 players</span>
                                    </div>
                                    <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.85rem; margin: 0;">
                                        Start the game with 2+ players • More can join before you start
                                    </p>
                                </div>

                                <div class="setting-group" style="margin-bottom: 20px;">
                                    <label style="color: white; font-weight: 600; margin-bottom: 10px; display: block;">
                                        📚 Room Themes <span id="themeSelectionCount" style="color: rgba(255,255,255,0.6); font-weight: normal; font-size: 0.9rem;">(0/5 selected)</span>
                                    </label>
                                    <div id="themeSelector" style="max-height: 300px; overflow-y: auto; padding: 8px; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 10px;">
                                        <div style="color: rgba(255,255,255,0.6); padding: 20px; text-align: center;">Loading themes...</div>
                                    </div>
                                    <p style="color: rgba(255, 255, 255, 0.6); font-size: 0.85rem; margin-top: 8px;">
                                        Select up to 5 themes • Only your configured themes
                                    </p>
                                </div>

                                <div class="setting-group" style="margin-bottom: 25px; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 10px; border: 1px solid rgba(76, 175, 80, 0.3);">
                                    <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                        <input type="checkbox" id="hostPlayingCheckbox" ${this.hostIsPlaying ? 'checked' : ''}
                                               style="width: 20px; height: 20px; cursor: pointer;">
                                        <div>
                                            <div style="font-weight: 600; color: white;">I'm playing in this game</div>
                                            <div style="color: rgba(255, 255, 255, 0.7); font-size: 0.85rem;">
                                                Uncheck to spectate only
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div class="modal-buttons">
                                <button class="btn btn-secondary" onclick="multiplayerManager.closeRoomSettingsModal()">
                                    Back
                                </button>
                                <button class="btn btn-primary" onclick="multiplayerManager.confirmCreateRoom()">
                                    Create Room
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', settingsHTML);
                this.loadThemesForRoom();
            }

            async loadThemesForRoom() {
                try {
                    const response = await fetch('/api/themes');
                    const data = await response.json();

                    if (data.success && data.themes) {
                        const themeSelector = document.getElementById('themeSelector');
                        const userThemes = JSON.parse(localStorage.getItem('selectedThemes') || '[]');

                        // Filter to only show themes user has selected in settings
                        const userSelectedThemes = data.themes.filter(theme => userThemes.includes(theme.id));

                        if (userSelectedThemes.length === 0) {
                            themeSelector.innerHTML = '<div style="color: rgba(255,255,255,0.6); padding: 20px; text-align: center;">No themes configured. Use Quick Start to select themes first.</div>';
                            return;
                        }

                        // Create checkbox items with styling
                        const checkboxItems = userSelectedThemes.map(theme => {
                            const creatorTag = theme.created_by ? ` @${theme.created_by}` : '';
                            return `
                                <label class="theme-checkbox-item" data-theme-id="${theme.id}" style="display: flex; align-items: center; padding: 12px; margin: 4px 0; background: rgba(255, 255, 255, 0.05); border-radius: 8px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent;">
                                    <input type="checkbox" value="${theme.id}" checked style="display: none;">
                                    <span class="checkmark" style="display: inline-flex; align-items: center; justify-content: center; width: 22px; height: 22px; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 5px; margin-right: 12px; background: rgba(76, 175, 80, 0.3); transition: all 0.2s;">
                                        ✓
                                    </span>
                                    <span style="flex: 1; color: white; font-size: 0.95rem;">
                                        ${theme.name}${creatorTag} <span style="color: rgba(255,255,255,0.5); font-size: 0.85rem;">(${theme.question_count || 0} questions)</span>
                                    </span>
                                </label>
                            `;
                        }).join('');

                        themeSelector.innerHTML = checkboxItems;
                        this.updateThemeSelectionCount();

                        // Add click handlers
                        themeSelector.querySelectorAll('.theme-checkbox-item').forEach(item => {
                            item.addEventListener('click', () => this.toggleThemeSelection(item));
                        });
                    }
                } catch (error) {
                    console.error('Failed to load themes:', error);
                    const selector = document.getElementById('themeSelector');
                    if (selector) {
                        selector.innerHTML = '<div style="color: rgba(255,255,255,0.6); padding: 20px; text-align: center;">Failed to load themes</div>';
                    }
                }
            }

            toggleThemeSelection(item) {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const checkmark = item.querySelector('.checkmark');
                const isChecked = checkbox.checked;

                // Get current selected count
                const selectedCount = document.querySelectorAll('.theme-checkbox-item input:checked').length;

                // If trying to select and already at limit, show error
                if (!isChecked && selectedCount >= 5) {
                    showError('Maximum 5 themes allowed per room');
                    return;
                }

                // Toggle checkbox
                checkbox.checked = !isChecked;

                // Update visual styling
                if (checkbox.checked) {
                    item.style.background = 'rgba(76, 175, 80, 0.2)';
                    item.style.borderColor = 'rgba(76, 175, 80, 0.5)';
                    checkmark.style.background = 'rgba(76, 175, 80, 0.5)';
                    checkmark.style.borderColor = 'rgba(76, 175, 80, 0.8)';
                    checkmark.textContent = '✓';
                } else {
                    item.style.background = 'rgba(255, 255, 255, 0.05)';
                    item.style.borderColor = 'transparent';
                    checkmark.style.background = 'transparent';
                    checkmark.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                    checkmark.textContent = '';
                }

                this.updateThemeSelectionCount();
            }

            updateThemeSelectionCount() {
                const selectedCount = document.querySelectorAll('.theme-checkbox-item input:checked').length;
                const countDisplay = document.getElementById('themeSelectionCount');
                if (countDisplay) {
                    countDisplay.textContent = `(${selectedCount}/5 selected)`;
                }
            }

            closeRoomSettingsModal() {
                const modal = document.getElementById('roomSettingsModal');
                if (modal) modal.remove();
                // Return to Multiplayer Options menu - use debounced showMenu
                this.showMenu();
            }

            confirmCreateRoom() {
                const hostPlayingCheckbox = document.getElementById('hostPlayingCheckbox');
                const themeSelector = document.getElementById('themeSelector');

                const maxPlayers = 10; // Hardcoded to 10 players max
                const hostIsPlaying = hostPlayingCheckbox ? hostPlayingCheckbox.checked : true;

                this.hostIsPlaying = hostIsPlaying;

                // Get selected themes from checkboxes
                const selectedThemes = Array.from(themeSelector.querySelectorAll('input[type="checkbox"]:checked'))
                    .map(checkbox => parseInt(checkbox.value));

                // Validate at least one theme is selected
                if (selectedThemes.length === 0) {
                    showError('Please select at least one theme for the room');
                    return;
                }

                const settings = JSON.parse(localStorage.getItem('quizSettings') || '{}');

                this.send('create_room', {
                    username: this.playerName,
                    selected_themes: selectedThemes,
                    question_count: settings.questionCount || 10,
                    time_limit: settings.timeLimit || 10,
                    max_players: maxPlayers,
                    host_is_playing: hostIsPlaying
                });

                this.closeRoomSettingsModal();
            }

            syncHostPlaying(players) {
                if (!Array.isArray(players)) return;
                const host = players.find(p => p.is_host);
                if (host && typeof host.is_playing === 'boolean') {
                    this.hostIsPlaying = host.is_playing;
                }
            }

            showJoinRoom() {
                this.closeMenu();
                if (document.getElementById('joinRoomModal')) return;
                const joinHTML = `
                    <div id="joinRoomModal" class="multiplayer-modal">
                        <div class="multiplayer-modal-content">
                            <h2>🔑 Join Private Room</h2>
                            <p>Enter the 6-character room code</p>
                            <input type="text" 
                                   id="roomCodeInput" 
                                   class="room-code-input" 
                                   placeholder="ABC123" 
                                   maxlength="6"
                                   oninput="this.value=this.value.toUpperCase()"
                                   onkeypress="if(event.key==='Enter') multiplayerManager.joinRoom()">
                            <div class="modal-buttons">
                                <button class="btn btn-secondary" onclick="multiplayerManager.closeJoinModal()">Back</button>
                                <button class="btn btn-primary" onclick="multiplayerManager.joinRoom()">Join Room</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', joinHTML);
                setTimeout(() => {
                    const input = document.getElementById('roomCodeInput');
                    if (input) input.focus();
                }, 50);
            }

            async joinRoom() {
                const input = document.getElementById('roomCodeInput');
                const roomCode = (input?.value || '').toUpperCase().trim();
                if (roomCode.length !== 6) {
                    showError('Please enter a valid 6-character room code');
                    return;
                }

                console.log(`[MultiplayerManager] Joining room: ${roomCode}`);

                // FIXED: Wait for proper connection instead of arbitrary timeout
                try {
                    await this.ensureConnected();
                } catch (error) {
                    console.error('[MultiplayerManager] Failed to connect:', error);
                    showError('Connection failed. Please try again.');
                    return;
                }

                // Joiners don't need to select themes - they use the host's themes
                this.send('join_room', {
                    room_code: roomCode,
                    username: this.playerName
                });
                this.closeJoinModal();
                this.currentRoomCode = roomCode;
                this.isHost = false;
            }

            toggleReady() {
                if (this.isHost) {
                    this.startGame();
                } else {
                    this.send('player_ready', { is_ready: true });
                    const btn = document.getElementById('readyBtn');
                    if (btn) { btn.textContent = 'Waiting...'; btn.disabled = true; }
                    const guest = document.getElementById('guestStatus');
                    if (guest) { guest.textContent = '✓'; guest.classList.add('ready'); }
                }
            }

            startGame() {
                this.send('start_game', {});
            }

            leaveRoom() {
                this.send('leave_room', {});
                this.closeAllModals();
                this.currentRoomCode = null;
                this.currentGameURL = null;
                this.isHost = false;

                // 🧹 Clean up multiplayer state from localStorage
                console.log('🧹 Cleaning up multiplayer state on leave...');
                localStorage.removeItem('multiplayerGame');
                localStorage.removeItem('currentRoomCode');
                localStorage.removeItem('currentGameURL');
                localStorage.removeItem('playerId');
                console.log('✅ Multiplayer state cleared');

                // Use debounced showMenu to prevent race conditions
                this.showMenu();
            }

            cancelSearch() {
                this.send('cancel_matchmaking', {});
                this.closeAllModals();
                // Use debounced showMenu to prevent race conditions
                this.showMenu();
            }

            copyRoomCode() {
                const code = this.currentRoomCode;
                if (!code) return;
                navigator.clipboard.writeText(code)
                    .then(() => showSuccess(`Room code ${code} copied!`))
                    .catch(() => showError('Failed to copy code'));
            }

            showMenu() {
                // Debounce: cancel any pending showMenu calls
                if (this.showMenuTimeout) {
                    clearTimeout(this.showMenuTimeout);
                    this.showMenuTimeout = null;
                }

                // If menu already exists, don't create another
                if (document.getElementById('multiplayerMenu')) return;

                if (!this.isConnected) this.connect();

                const menuHTML = `
                    <div id="multiplayerMenu" class="themes-modal" onclick="if(event.target === this) multiplayerManager.closeMenu()">
                        <div class="themes-modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
                            <div class="themes-modal-header">
                                <h2>⚔️ Multiplayer</h2>
                                <button class="btn btn-secondary" onclick="multiplayerManager.closeMenu()">Cancel</button>
                            </div>
                            <div style="padding: 20px 0;">
                                <div style="display: flex; flex-direction: column; gap: 15px;">
                                    <button class="multiplayer-option-btn" onclick="multiplayerManager.quickMatch()">
                                        <div class="option-icon">⚡</div>
                                        <div class="option-text">
                                            <h3>Quick Match</h3>
                                            <p>Find a random opponent</p>
                                        </div>
                                    </button>
                                    <button class="multiplayer-option-btn" onclick="multiplayerManager.createPrivateRoom()">
                                        <div class="option-icon">🏠</div>
                                        <div class="option-text">
                                            <h3>Create Private Room</h3>
                                            <p>Host a game with friends</p>
                                        </div>
                                    </button>
                                    <button class="multiplayer-option-btn" onclick="multiplayerManager.showJoinRoom()">
                                        <div class="option-icon">🔑</div>
                                        <div class="option-text">
                                            <h3>Join Private Room</h3>
                                            <p>Enter a 6-character code</p>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', menuHTML);
            }

            closeMenu() {
                // Cancel any pending showMenu calls
                if (this.showMenuTimeout) {
                    clearTimeout(this.showMenuTimeout);
                    this.showMenuTimeout = null;
                }
                const menu = document.getElementById('multiplayerMenu');
                if (menu) menu.remove();
            }

            closeJoinModal() {
                const modal = document.getElementById('joinRoomModal');
                if (modal) modal.remove();
                // Use setTimeout to ensure modal is removed before showing menu
                setTimeout(() => this.showMenu(), 10);
            }

        showWaitingRoom(roomCode, isHost) {
            this.currentRoomCode = roomCode;
            this.isHost = isHost;
            if (document.getElementById('waitingRoomModal')) return;
            const waitingHTML = `
                <div id="waitingRoomModal" class="multiplayer-modal">
                    <div class="multiplayer-modal-content">
                        <h2>${isHost ? '🏠 Private Room' : '🔓 Joined Room'}</h2>
                        <div class="room-code-display">
                            <p>Room Code:</p>
                            <div class="room-code-large" id="displayRoomCode">${roomCode}</div>
                            <button class="copy-btn" onclick="multiplayerManager.copyRoomCode()">📋 Copy Code</button>
                        </div>
                        ${isHost && !this.hostIsPlaying ? `
                            <div style="padding: 12px; background: rgba(255, 193, 7, 0.1); border-radius: 10px; border: 1px solid rgba(255, 193, 7, 0.3); margin: 15px 0;">
                                <div style="display: flex; align-items: center; gap: 10px; color: #ffc107;">
                                    <span style="font-size: 1.5rem;">👁️</span>
                                    <span style="font-weight: 600;">Spectating Mode</span>
                                </div>
                                <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.85rem; margin-top: 5px;">
                                    You're watching this game, not playing
                                </p>
                            </div>
                        ` : ''}
                        <div id="playersContainer" class="players-in-room">
                            <!-- Players will be dynamically updated -->
                        </div>
                        <button id="readyBtn" class="btn btn-primary" onclick="multiplayerManager.toggleReady()" ${isHost ? 'disabled' : ''}>
                            ${isHost ? 'Waiting for Players' : 'Ready'}
                        </button>
                        <button class="btn btn-secondary" onclick="multiplayerManager.leaveRoom()">Leave Room</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', waitingHTML);
        }

                    updatePlayerList(data) {
                const container = document.getElementById('playersContainer');
                if (!container || !data.players) return;
                
                container.innerHTML = data.players.map(p => {
                    const isSpectating = p.is_host && !p.is_playing;
                    const statusIcon = isSpectating ? '👁️' : (p.is_ready ? '✓' : '○');
                    const statusClass = p.is_ready ? 'ready' : '';
                    const hostTag = p.is_host ? ' (Host)' : '';
                    const spectatingTag = isSpectating ? ' - Spectating' : '';
                    const youTag = p.player_id === this.playerId ? ' - You' : '';

                    return `
                        <div class="player-slot" style="${isSpectating ? 'opacity: 0.6; font-style: italic;' : ''}">
                            <span class="player-status ${statusClass}">
                                ${statusIcon}
                            </span>
                            <span>@${p.username}${hostTag}${spectatingTag}${youTag}</span>
                        </div>
                    `;
                }).join('');
                
                const btn = document.getElementById('readyBtn');
                if (btn && this.isHost) {
                    const playingPlayers = data.players.filter(p => p.is_playing);
                    const readyPlayingPlayers = playingPlayers.filter(p => p.is_ready);

                    const canStart = playingPlayers.length >= 2 &&
                                    readyPlayingPlayers.length === playingPlayers.length;

                    btn.disabled = !canStart;
                    btn.textContent = canStart
                        ? 'Start Game'
                        : `Waiting (${readyPlayingPlayers.length}/${playingPlayers.length} ready)`;
                }
            }
                        showSearchingModal() {
                if (document.getElementById('searchingModal')) return;
                const modal = document.createElement('div');
                modal.id = 'searchingModal';
                modal.className = 'multiplayer-modal';
                modal.innerHTML = `
                    <div class="multiplayer-modal-content">
                        <div class="spinner"></div>
                        <h2>🔍 Finding Opponent...</h2>
                        <p>Searching for a player with similar settings</p>
                        <button class="btn btn-secondary" onclick="multiplayerManager.cancelSearch()">Back</button>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            showMatchFoundNotification() {
                if (this.matchOverlayShown) return;
                this.matchOverlayShown = true;
                const notification = document.createElement('div');
                notification.id = 'matchFoundNotification';
                notification.className = 'match-found-notification';
                notification.innerHTML = `
                    <div class="match-found-content">
                        <h2>⚔️ Match Found!</h2>
                        <p>Starting game...</p>
                    </div>
                `;
                document.body.appendChild(notification);
            }

            handleMatchFound(_payload) {
                this.closeAllModals();
                // Don't show notification here - wait for game_start to show it once
            }

            closeAllModals() {
                ['multiplayerMenu', 'joinRoomModal', 'waitingRoomModal', 'searchingModal', 'matchFoundNotification'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.remove();
                });
            }

            attemptReconnect() {
                if (this.reconnectAttempts >= this.maxReconnectAttempts) {
                    return;
                }
                this.reconnectAttempts++;
                const delay = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 10000);
                clearTimeout(this.reconnectTimeout);
                this.reconnectTimeout = setTimeout(() => this.connect(), delay);
            }
        }

        const multiplayerManager = new MultiplayerManager();

        // ==============================
        // Auth helpers
        // ==============================
        function updateLoginUI() {
            const playerName = localStorage.getItem('playerName');
            if (playerName) {
                document.getElementById('playerNameDisplay').textContent = '@' + playerName;
                document.getElementById('loginLink').style.display = 'none';
                document.getElementById('logoutLink').style.display = 'block';
            } else {
                document.getElementById('playerNameDisplay').textContent = '@Guest';
                document.getElementById('loginLink').style.display = 'block';
                document.getElementById('logoutLink').style.display = 'none';
            }
        }

        function openLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';

            // Load remembered username
            const rememberedUsername = localStorage.getItem('rememberedUsername');
            const usernameInput = document.getElementById('username');
            const rememberCheckbox = document.getElementById('rememberMe');

            if (rememberedUsername && usernameInput) {
                usernameInput.value = rememberedUsername;
                if (rememberCheckbox) rememberCheckbox.checked = true;
                console.log('✅ Loaded remembered username:', rememberedUsername);
            }

            setTimeout(() => {
                if (usernameInput) {
                    if (rememberedUsername) {
                        // If username is remembered, focus password field
                        const passwordInput = document.getElementById('password');
                        if (passwordInput) passwordInput.focus();
                    } else {
                        // Otherwise focus username field
                        usernameInput.focus();
                    }
                }
            }, 50);
        }

        async function continueAsGuest() {
            try {
                const response = await fetch('/api/auth/guest', { method: 'POST', headers: { 'Content-Type': 'application/json' }});
                const data = await response.json();
                if (data.success) {
                    // Clear old data first
                    localStorage.removeItem('token');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('user');

                    // Save new credentials
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('authToken', data.token); // Backwards compatibility
                    localStorage.setItem('playerName', data.user.username);
                    localStorage.setItem('userId', data.user.id);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    localStorage.setItem('isGuest', 'true');
                    localStorage.setItem('hasVisited', 'true');
                    document.getElementById('loginModal').style.display = 'none';
                    updateLoginUI();
                    showSuccess('Welcome, @' + data.user.username + '!');
                } else {
                    showError(data.message || 'Failed to create guest session');
                }
            } catch (e) {
                console.error(e);
                showError('Connection error. Please try again.');
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const rememberMe = document.getElementById('rememberMe').checked;

            if (!username || !password) {
                showError('Please enter both username and password');
                return;
            }

            // Handle Remember Me checkbox
            if (rememberMe) {
                localStorage.setItem('rememberedUsername', username);
                console.log('✅ Username saved for next time');
            } else {
                localStorage.removeItem('rememberedUsername');
                console.log('❌ Username not saved');
            }

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();
                if (data.success) {
                    // Clear old tokens first to prevent conflicts
                    console.log('🔐 Login successful, clearing old data...');
                    localStorage.removeItem('token');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('user');

                    // Save new credentials
                    console.log('🔐 Saving new token and user data...');
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('authToken', data.token); // Backwards compatibility
                    localStorage.setItem('playerName', data.user.username);
                    localStorage.setItem('userId', data.user.id);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    localStorage.setItem('isGuest', 'false');
                    localStorage.setItem('hasVisited', 'true');

                    // Verify it was saved
                    console.log('🔐 Verification:', {
                        tokenSaved: !!localStorage.getItem('token'),
                        userSaved: !!localStorage.getItem('user'),
                        userId: data.user.id
                    });

                    document.getElementById('loginModal').style.display = 'none';
                    updateLoginUI();
                    showSuccess('Welcome back, @' + data.user.username + '!');
                } else {
                    showError(data.message || 'Login failed');
                }
            } catch (e) {
                console.error(e);
                showError('Connection error. Please try again.');
            }
        }

        function showRegister() {
            const isGuest = localStorage.getItem('isGuest') === 'true';
            if (isGuest) {
                if (confirm('Convert your guest account to a permanent account?')) {
                    showUpgradeModal();
                }
            } else {
                showRegisterModal();
            }
        }

        function showRegisterModal() {
            const registerHTML = `
                <div id="registerModal" class="login-modal" style="display: flex;">
                    <div class="login-modal-content">
                        <h2>Create Account</h2>
                        <p class="login-subtitle">Join U Bible to track progress and compete</p>
                        <form class="login-form" onsubmit="handleRegister(event)">
                            <div class="form-group">
                                <label>Username</label>
                                <input type="text" id="registerUsername" placeholder="Choose a username" required autocomplete="username">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="registerEmail" placeholder="Enter your email" required autocomplete="email">
                            </div>
                            <div class="form-group">
                                <label>Password</label>
                                <div class="password-wrapper">
                                    <input type="password" id="registerPassword" placeholder="Create a password (min 6 characters)" required autocomplete="new-password">
                                    <button type="button" class="password-toggle" onclick="togglePasswordVisibility('registerPassword', this)">
                                        👁️
                                    </button>
                                </div>
                            </div>
                            <div class="login-actions">
                                <button type="submit" class="btn btn-primary">Create Account</button>
                                <button type="button" class="btn btn-secondary" onclick="closeRegisterModal(); openLoginModal();">Back to Login</button>
                            </div>
                        </form>
                        <div class="guest-link" style="text-align: center; margin-top: 15px;">
                            Already have an account? <a href="#" onclick="closeRegisterModal(); openLoginModal(); return false;" style="color: #4ecdc4; text-decoration: none;">Login here</a>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', registerHTML);
        }

        function closeRegisterModal() {
            const modal = document.getElementById('registerModal');
            if (modal) modal.remove();
        }

        async function handleRegister(event) {
            event.preventDefault();
            const username = document.getElementById('registerUsername').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value.trim();

            if (!username || !email || !password) {
                showError('Please fill in all fields');
                return;
            }

            if (password.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });
                const data = await response.json();
                if (data.success) {
                    // Clear old data first
                    localStorage.removeItem('token');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('user');

                    // Save new credentials
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('authToken', data.token); // Backwards compatibility
                    localStorage.setItem('playerName', data.user.username);
                    localStorage.setItem('userId', data.user.id);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    localStorage.setItem('isGuest', 'false');
                    localStorage.setItem('hasVisited', 'true');
                    closeRegisterModal();
                    updateLoginUI();
                    showSuccess('Account created successfully! Welcome, @' + data.user.username + '!');
                } else {
                    showError(data.error || data.message || 'Registration failed');
                }
            } catch (e) {
                console.error(e);
                showError('Connection error. Please try again.');
            }
        }

        function showUpgradeModal() {
            const upgradeHTML = `
                <div id="upgradeModal" class="login-modal" style="display: flex;">
                    <div class="login-modal-content">
                        <h2>Upgrade to Full Account</h2>
                        <p class="login-subtitle">Keep all your progress and stats!</p>
                        <form class="login-form" onsubmit="handleUpgrade(event)">
                            <div class="form-group">
                                <label>Choose Username</label>
                                <input type="text" id="upgradeUsername" placeholder="Enter your username" required>
                            </div>
                            <div class="form-group">
                                <label>Email Address</label>
                                <input type="email" id="upgradeEmail" placeholder="Enter your email" required>
                            </div>
                            <div class="form-group">
                                <label>Choose Password</label>
                                <div class="password-wrapper">
                                    <input type="password" id="upgradePassword" placeholder="Enter your password" required>
                                    <button type="button" class="password-toggle" onclick="togglePasswordVisibility('upgradePassword', this)">
                                        👁️
                                    </button>
                                </div>
                            </div>
                            <div class="login-actions">
                                <button type="submit" class="btn btn-primary">Upgrade Account</button>
                                <button type="button" class="btn btn-secondary" onclick="closeUpgradeModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('loginModal').style.display = 'none';
            document.body.insertAdjacentHTML('beforeend', upgradeHTML);
        }

        function closeUpgradeModal() {
            const modal = document.getElementById('upgradeModal');
            if (modal) modal.remove();
        }

        async function handleUpgrade(event) {
            event.preventDefault();
            const username = document.getElementById('upgradeUsername').value.trim();
            const email = document.getElementById('upgradeEmail').value.trim();
            const password = document.getElementById('upgradePassword').value.trim();
            if (!username || !email || !password) {
                showError('Please enter username, email, and password');
                return;
            }
            try {
                const token = localStorage.getItem('token') || localStorage.getItem('authToken');
                console.log('Upgrading account with token:', token ? 'present' : 'missing');
                const response = await fetch('/api/auth/upgrade', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ username, email, password })
                });
                const data = await response.json();
                if (data.success) {
                    // Clear old data first
                    localStorage.removeItem('token');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('user');

                    // Save new credentials
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('authToken', data.token); // Backwards compatibility
                    localStorage.setItem('playerName', data.user.username);
                    localStorage.setItem('userId', data.user.id);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    localStorage.setItem('isGuest', 'false');
                    closeUpgradeModal();
                    updateLoginUI();
                    showSuccess('Account upgraded! You can now login with your credentials.');
                } else {
                    showError(data.message || 'Upgrade failed');
                }
            } catch (e) {
                console.error(e);
                showError('Connection error. Please try again.');
            }
        }

        function togglePasswordVisibility(inputId, button) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = '🙈'; // Hide icon
            } else {
                input.type = 'password';
                button.textContent = '👁️'; // Show icon
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('authToken');
            localStorage.removeItem('playerName');
            localStorage.removeItem('userId');
            localStorage.removeItem('user');
            localStorage.removeItem('isGuest');
            localStorage.removeItem('hasVisited');
            updateLoginUI();
            openLoginModal();
            showSuccess('Logged out successfully');
        }

        // ==============================
        // Other app functions
        // ==============================
        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                container.appendChild(particle);
            }
        }

        async function fetchHealth() {
            // Try /health first, fallback to /api/health to avoid 404 noise
            try {
                const r1 = await fetch('/health');
                if (r1.ok) return r1.json();
            } catch {}
            try {
                const r2 = await fetch('/api/health');
                if (r2.ok) return r2.json();
            } catch {}
            return null;
        }

        async function loadStats() {
            try {
                // Get user's selected themes from localStorage/database
                const selectedThemes = SettingsManager.getSelectedThemes();
                document.getElementById('themeCount').textContent = selectedThemes.length;

                // Calculate verses from SELECTED themes only (not all verses in database)
                let totalVerses = 0;

                if (selectedThemes.length > 0) {
                    // Fetch all themes with their question counts
                    const themesResponse = await fetch('/api/themes');
                    if (themesResponse.ok) {
                        const themesData = await themesResponse.json();
                        if (themesData.success && themesData.themes) {
                            // Sum up question counts for selected themes only
                            themesData.themes.forEach(theme => {
                                if (selectedThemes.includes(theme.id)) {
                                    // Use question_count from API (not questions array)
                                    if (theme.question_count) {
                                        totalVerses += theme.question_count;
                                    }
                                }
                            });
                        }
                    }
                }

                document.getElementById('verseCount').textContent = totalVerses;

                // Load user rank and rating from database (if logged in)
                const token = localStorage.getItem('token');
                if (token) {
                    const userResponse = await fetch('/api/users/me', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (userResponse.ok) {
                        const userData = await userResponse.json();
                        if (userData.success && userData.user) {
                            const userId = userData.user.id;

                            // Display rating in Best badge (0-10 scale)
                            if (typeof userData.user.rating === 'number') {
                                document.getElementById('bestScore').textContent = userData.user.rating.toFixed(1);
                            }

                            // Fetch user rank
                            const rankResponse = await fetch(`/api/leaderboard/user/${userId}?category=xp`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            if (rankResponse.ok) {
                                const rankData = await rankResponse.json();
                                if (rankData.success) {
                                    document.getElementById('rank').textContent = '#' + rankData.rank;
                                }
                            }
                        }
                    }
                } else {
                    document.getElementById('rank').textContent = '--';
                    document.getElementById('bestScore').textContent = '--';
                }

                // Load online players count from database
                const playersResponse = await fetch('/api/stats/players');
                if (playersResponse.ok) {
                    const playersData = await playersResponse.json();
                    if (playersData.success) {
                        document.getElementById('playersOnline').textContent = playersData.count;
                    }
                }

                // Load last played time
                const lastPlayedResponse = await fetch('/api/stats/last-played');
                if (lastPlayedResponse.ok) {
                    const lastPlayedData = await lastPlayedResponse.json();
                    if (lastPlayedData.success) {
                        document.getElementById('lastPlayed').textContent = lastPlayedData.lastPlayed;
                    }
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }

            const quizStats = localStorage.getItem('quiz.stats.lifetime');
            if (quizStats) {
                try {
                    const stats = JSON.parse(quizStats);
                    if (stats.bestAccuracy) {
                        document.getElementById('bestScore').textContent = Math.round(stats.bestAccuracy) + '%';
                    }
                    if (stats.lastPlayedISO) {
                        const date = new Date(stats.lastPlayedISO);
                        const today = new Date();
                        const diffDays = Math.floor((today - date) / (1000 * 60 * 60 * 24));
                        if (diffDays === 0) {
                            document.getElementById('lastPlayed').textContent = 'Today';
                        } else if (diffDays === 1) {
                            document.getElementById('lastPlayed').textContent = 'Yesterday';
                        } else if (diffDays < 7) {
                            document.getElementById('lastPlayed').textContent = diffDays + ' days ago';
                        } else {
                            document.getElementById('lastPlayed').textContent = date.toLocaleDateString();
                        }
                    }
                } catch {}
            }

            // Ensure the stats badges reflect latest settings
            SettingsManager.updateBadges();
        }

        function startPractice() {
            // 🧹 Clear any multiplayer state before starting practice mode
            console.log('🧹 Cleaning up multiplayer state before practice...');
            localStorage.removeItem('multiplayerGame');
            localStorage.removeItem('currentRoomCode');
            localStorage.removeItem('currentGameURL');
            localStorage.removeItem('playerId');
            console.log('✅ Multiplayer state cleared');

            location.href = '/practice.html';
        }

        function showHelp() {
            const helpContent = `⚡ Quick Start - Jump into practice with default settings
⚔️ Multiplayer - Race against other players in real-time
   • Quick Match - Find random opponent
   • Create Room - Get a code to share with friends
   • Join Room - Enter a friend's room code
🎯 Challenges - Share your score and challenge friends
📚 Practice - Select themes and practice at your own pace
⚡ Quick Start - Configure and start your quiz instantly`;
            showModal('U Bible Help', helpContent);
        }

        function showAbout() {
            const aboutContent = `<strong style="color: #4ecdc4; font-size: 18px;">About This App</strong>

This app was created by <strong>Apostle Maliyabwana</strong>, the current Overseer and Apostle of the Ukweli Church of Christ, also known as Ukweli Ministries.

Born Meshak Mausa, Maliyabwana began programming in 2012, inspired by the story of Mark Zuckerberg, who built his first app at the age of 12. Motivated by that story, he immersed himself in computer science and discovered Codeacademy (now known as Codecademy).

He spent countless hours—sometimes up to 24 hours a day without sleep—on his father's computer learning web design and programming. This deep dedication continued until the age of 13, when his creative passions began to expand in new directions.

During that period, he taught himself Photoshop, believing that building clean and professional websites required strong design skills. This opened the door to photo editing, and a few years later, to music production. Eventually, he founded the NDP Entertainment Label, operating under the alias Six Sons, where he produced music and designed cover art for his friends.

His love for technology and creativity later led him into the field of sound engineering, merging his artistic expression with technical skill.

Born and raised in Tanzania (TZ), Maliyabwana moved to the United States in 2010 at the age of 10, carrying with him a deep passion for knowledge, innovation, and purpose—values that continue to shape both his ministry and his creative work today.

<strong style="color: #4ecdc4; font-size: 18px; display: block; margin-top: 20px;">Support the Project</strong>

This app is still in its improvement stage, and your support can help it grow. If you'd like to contribute, you can donate via:

💵 <strong>Cash App:</strong> $ukweliministries
💳 <strong>PayPal:</strong> @ukweliministries

<div style="margin-top: 20px; padding: 15px; background: rgba(78, 205, 196, 0.1); border-left: 3px solid #4ecdc4; border-radius: 8px;">
<strong>U Bible v2.0.0</strong>
An interactive Bible verse learning application with multiplayer support.

<strong style="display: block; margin-top: 10px;">Features:</strong>
• Real-time multiplayer races
• Private rooms with shareable codes
• Share challenges with friends
• Track your progress
• Custom theme creation
</div>`;
            showModal('About U Bible', aboutContent);
        }

        function resetData() {
            if (confirm('This will reset all your progress. Are you sure?')) {
                localStorage.clear();
                location.reload();
            }
        }

        // ==============================
        // Theme Search & Bank Management
        // ==============================
        let searchTimeout;
        let allThemes = [];
        const MAX_BANK_THEMES = 10;

        // Load all themes on page load
        async function loadAllThemes() {
            try {
                console.log('🔍 Loading themes from database...');
                const response = await fetch('/api/themes');
                if (!response.ok) throw new Error('Failed to fetch themes');
                const data = await response.json();
                allThemes = data.themes || [];
                console.log(`✅ Loaded ${allThemes.length} themes from database`);
            } catch (error) {
                console.error('❌ Error loading themes:', error);
            }
        }

        // Get themes from bank
        function getThemeBank() {
            const bank = localStorage.getItem('themeBank');
            return bank ? JSON.parse(bank) : [];
        }

        // Save theme to bank
        function saveThemeToBank(themeId, themeName, questionCount, createdBy) {
            console.log(`💾 Saving theme to bank:`, { themeId, themeName, questionCount, createdBy });
            const bank = getThemeBank();

            // Check if already in bank
            if (bank.some(t => t.id === themeId)) {
                console.warn('⚠️ Theme already in bank');
                showError('Theme already in your bank');
                return false;
            }

            // Check if bank is full
            if (bank.length >= MAX_BANK_THEMES) {
                console.warn(`⚠️ Bank is full (${bank.length}/${MAX_BANK_THEMES})`);
                showError(`Bank is full! Maximum ${MAX_BANK_THEMES} themes allowed`);
                return false;
            }

            // Add to bank
            bank.push({
                id: themeId,
                name: themeName,
                question_count: questionCount,
                created_by: createdBy
            });

            localStorage.setItem('themeBank', JSON.stringify(bank));
            console.log(`✅ Theme saved! Bank now has ${bank.length}/${MAX_BANK_THEMES} themes:`, bank);
            showSuccess(`✅ ${themeName} saved to bank (${bank.length}/${MAX_BANK_THEMES})`);

            // Refresh search results to update button states
            const searchInput = document.getElementById('themeSearch');
            if (searchInput.value) {
                searchThemes(searchInput.value);
            }

            return true;
        }

        function removeThemeFromBank(themeId, themeName) {
            console.log(`🗑️ Removing theme from bank:`, { themeId, themeName });
            const bank = getThemeBank();
            const filtered = bank.filter(t => t.id !== themeId);

            if (filtered.length === bank.length) {
                console.warn('⚠️ Theme not found in bank');
                showError('Theme not found in bank');
                return false;
            }

            localStorage.setItem('themeBank', JSON.stringify(filtered));
            console.log(`✅ Theme removed! Bank now has ${filtered.length}/${MAX_BANK_THEMES} themes:`, filtered);
            showSuccess(`🗑️ ${themeName} removed from bank (${filtered.length}/${MAX_BANK_THEMES})`);

            // Refresh search results to update button states
            const searchInput = document.getElementById('themeSearch');
            if (searchInput.value) {
                searchThemes(searchInput.value);
            }

            return true;
        }

        function searchThemes(query) {
            clearTimeout(searchTimeout);

            const resultsContainer = document.getElementById('searchResults');

            if (!query || query.trim().length === 0) {
                resultsContainer.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(async () => {
                const searchQuery = query.toLowerCase().trim();
                const bank = getThemeBank();
                const bankIds = bank.map(t => t.id);

                console.log(`🔍 Searching for: "${searchQuery}" in ${allThemes.length} themes`);

                // Filter themes
                const matches = allThemes.filter(theme => {
                    const themeName = (theme.name || '').toLowerCase();
                    const creatorName = (theme.created_by || '').toLowerCase();
                    return themeName.includes(searchQuery) || creatorName.includes(searchQuery);
                });

                console.log(`✅ Found ${matches.length} matching themes`);

                // Display results
                if (matches.length === 0) {
                    resultsContainer.innerHTML = '<div class="no-results">🔍 No themes found</div>';
                } else {
                    resultsContainer.innerHTML = matches.slice(0, 10).map(theme => {
                        const creatorTag = theme.created_by ? ` · @${theme.created_by}` : '';
                        const inBank = bankIds.includes(theme.id);
                        const bankFull = bank.length >= MAX_BANK_THEMES;

                        let buttonHTML;
                        if (inBank) {
                            buttonHTML = `<button class="save-to-bank-btn remove" onclick="event.stopPropagation(); removeThemeFromBank(${theme.id}, '${theme.name.replace(/'/g, "\\'")}')">🗑️ Remove</button>`;
                        } else if (bankFull) {
                            buttonHTML = '<button class="save-to-bank-btn disabled" disabled>Bank Full</button>';
                        } else {
                            buttonHTML = `<button class="save-to-bank-btn" onclick="event.stopPropagation(); saveThemeToBank(${theme.id}, '${theme.name.replace(/'/g, "\\'")}', ${theme.question_count || 0}, '${theme.created_by || ''}')">💾 Save</button>`;
                        }

                        return `
                            <div class="search-result-item">
                                <div class="search-result-content" onclick="selectTheme(${theme.id}, '${theme.name.replace(/'/g, "\\'")}')">
                                    <div class="search-result-title">${theme.name}</div>
                                    <div class="search-result-meta">${theme.question_count || 0} questions${creatorTag}</div>
                                </div>
                                ${buttonHTML}
                            </div>
                        `;
                    }).join('');
                }

                resultsContainer.style.display = 'block';
            }, 300);
        }

        async function selectTheme(themeId, themeName) {
            // Close search results
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('themeSearch').value = '';

            // Show theme preview modal
            showThemePreviewModal(themeId, themeName);
        }

        async function showThemePreviewModal(themeId, themeName) {
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'themePreviewModal';
            modal.className = 'multiplayer-modal';
            modal.onclick = (e) => { if (e.target === modal) closeThemePreviewModal(); };
            modal.innerHTML = `
                <div class="multiplayer-modal-content" style="max-width: 700px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
                    <button class="modal-close-btn" onclick="closeThemePreviewModal()">✕</button>
                    <h2 style="margin-bottom: 10px;">📖 ${themeName}</h2>
                    <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="window.location.href='/practice.html?theme=${themeId}'">
                            📚 Practice
                        </button>
                        <button class="btn btn-primary" onclick="window.location.href='/quiz.html?theme=${themeId}'">
                            ⚡ Quiz
                        </button>
                        <button class="btn btn-secondary" onclick="closeThemePreviewModal()">Close</button>
                    </div>
                    <div id="themeVersesList" style="overflow-y: auto; flex: 1;">
                        <div style="text-align: center; padding: 40px;">
                            <div class="spinner"></div>
                            <p>Loading verses...</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Fetch verses
            try {
                const response = await fetch(`/api/practice/cards?theme_id=${themeId}&limit=100`);
                const data = await response.json();

                if (data.success && data.cards && data.cards.length > 0) {
                    const versesHTML = `
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 10px; margin-bottom: 15px;">
                            <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.9rem; margin: 0;">
                                📝 ${data.cards.length} verse${data.cards.length === 1 ? '' : 's'} in this theme
                            </p>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${data.cards.slice(0, 50).map((card, idx) => {
                                // Skip verses that only have reference (cross-references without text)
                                const isOnlyReference = card.verse_text && card.verse_text.trim() === (card.reference || '').trim();
                                if (isOnlyReference || !card.verse_text || card.verse_text.trim() === '') {
                                    return ''; // Skip this card
                                }
                                return `
                                    <div style="background: rgba(255, 255, 255, 0.08); padding: 15px; border-radius: 10px; border-left: 3px solid #4ecdc4;">
                                        <div style="font-weight: 600; color: #4ecdc4; margin-bottom: 5px; font-size: 0.85rem;">
                                            ${card.reference || `Verse ${idx + 1}`}
                                        </div>
                                        <div style="color: rgba(255, 255, 255, 0.9); line-height: 1.6; font-size: 0.95rem;">
                                            ${card.verse_text}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                            ${data.cards.length > 50 ? `
                                <div style="text-align: center; padding: 15px; color: rgba(255, 255, 255, 0.6); font-size: 0.9rem;">
                                    ... and ${data.cards.length - 50} more verses
                                </div>
                            ` : ''}
                        </div>
                    `;
                    document.getElementById('themeVersesList').innerHTML = versesHTML;
                } else {
                    document.getElementById('themeVersesList').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.6);">
                            <p>📭 No verses found for this theme</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading verses:', error);
                document.getElementById('themeVersesList').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ff5252;">
                        <p>❌ Failed to load verses</p>
                    </div>
                `;
            }
        }

        function closeThemePreviewModal() {
            const modal = document.getElementById('themePreviewModal');
            if (modal) modal.remove();
        }

        // Click outside to close search results
        document.addEventListener('click', function(e) {
            const searchBox = document.querySelector('.search-box');
            const resultsContainer = document.getElementById('searchResults');
            if (searchBox && resultsContainer && !searchBox.contains(e.target)) {
                resultsContainer.style.display = 'none';
            }
        });

        // Load themes when page loads
        loadAllThemes();

        // ==============================
        // Quick Start
        // ==============================
        async function quickStart() {
            console.log('Quick Start clicked');

            // 🧹 Clear any multiplayer state before starting single player
            console.log('Cleaning up multiplayer state...');
            localStorage.removeItem('multiplayerGame');
            localStorage.removeItem('currentRoomCode');
            localStorage.removeItem('currentGameURL');
            localStorage.removeItem('playerId');
            console.log('✅ Multiplayer state cleared');

            try {
                const settings = SettingsManager.getSettings();
                const selectedThemes = SettingsManager.getSelectedThemes();

                console.log('Quick Start - Settings:', settings);
                console.log('Quick Start - Selected Themes:', selectedThemes);

                if (!selectedThemes.length) {
                    showError('Please select themes before starting!');
                    // Open Quick Start modal to let them select themes
                    return;
                }

                // Show preview modal
                await showQuickStartPreview(settings, selectedThemes);
            } catch (error) {
                console.error('Quick Start error:', error);
                showError('Error starting quiz. Please try again.');
            }
        }

        function calculateThemesContainerHeight(themeCount) {
            // Calculate dynamic fixed height based on number of themes
            const headerHeight = 40; // Height of "X Themes Selected" header
            const itemHeight = 50;   // Approximate height per theme item
            const padding = 16;      // Container padding
            const minHeight = 100;   // Minimum container height
            const maxHeight = 250;   // Maximum container height

            // Calculate: header + (number of themes * item height) + padding
            const calculatedHeight = headerHeight + (themeCount * itemHeight) + padding;

            // Clamp between min and max
            return Math.max(minHeight, Math.min(maxHeight, calculatedHeight));
        }

        async function showQuickStartPreview(settings, selectedThemeIds) {
            const modal = document.getElementById('quickStartModal');
            const container = document.getElementById('quickStartContainer');

            try {
                // Fetch theme details
                const response = await fetch('/api/themes');
                const data = await response.json();

                if (!data.success || !data.themes) {
                    throw new Error('Failed to load themes');
                }

                const allThemes = data.themes;
                const selectedThemesData = allThemes.filter(theme => selectedThemeIds.includes(theme.id));

                // Create checkboxes for ALL themes
                const allThemesHTML = allThemes.map(theme => {
                    const isSelected = selectedThemeIds.includes(theme.id);
                    return `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 6px; background: rgba(255, 255, 255, ${isSelected ? '0.1' : '0.03'}); border-radius: 6px; margin-bottom: 4px; cursor: pointer; transition: all 0.2s;" onclick="toggleQuickStartTheme(${theme.id}, this)" onmouseover="this.style.background='rgba(76, 175, 80, 0.15)'" onmouseout="this.style.background='rgba(255, 255, 255, ${isSelected ? '0.1' : '0.03'})'">
                            <input type="checkbox" ${isSelected ? 'checked' : ''} style="cursor: pointer;" onclick="event.stopPropagation()">
                            <div style="flex: 1;">
                                <div style="color: white; font-size: 0.85rem; font-weight: 500;">${theme.name}</div>
                                <div style="color: rgba(255, 255, 255, 0.5); font-size: 0.7rem;">${theme.question_count || 0} questions</div>
                            </div>
                        </div>
                    `;
                }).join('');

                const questionType = localStorage.getItem('questionType') || 'reference';

                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                        <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 8px; text-align: center;">
                            <div style="color: rgba(255, 255, 255, 0.6); font-size: 0.75rem; margin-bottom: 4px;">Time/Question</div>
                            <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <button onclick="adjustTimeLimit(-1)" style="width: 24px; height: 24px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='rgba(76, 175, 80, 0.3)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'">−</button>
                                <div id="timeLimitDisplay" style="color: #4caf50; font-size: 1.1rem; font-weight: 600; min-width: 40px;">${settings.timeLimit}s</div>
                                <button onclick="adjustTimeLimit(1)" style="width: 24px; height: 24px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='rgba(76, 175, 80, 0.3)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'">+</button>
                            </div>
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 8px; text-align: center;">
                            <div style="color: rgba(255, 255, 255, 0.6); font-size: 0.75rem; margin-bottom: 4px;">Questions</div>
                            <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <button onclick="adjustQuestionCount(-1)" style="width: 24px; height: 24px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='rgba(76, 175, 80, 0.3)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'">−</button>
                                <div id="questionCountDisplay" style="color: #4caf50; font-size: 1.1rem; font-weight: 600; min-width: 40px;">${settings.questionCount}</div>
                                <button onclick="adjustQuestionCount(1)" style="width: 24px; height: 24px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='rgba(76, 175, 80, 0.3)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'">+</button>
                            </div>
                        </div>
                    </div>

                    <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 10px; margin-bottom: 12px;">
                        <div style="color: rgba(255, 255, 255, 0.6); font-size: 0.75rem; margin-bottom: 6px; text-align: center;">Question Type</div>
                        <div style="position: relative; background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.2)); border-radius: 20px; padding: 3px; display: grid; grid-template-columns: 1fr 1fr 1fr; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);">
                            <div data-toggle-slider style="position: absolute; top: 3px; bottom: 3px; width: calc(33.333% - 2px); background: linear-gradient(135deg, #4caf50, #66bb6a); border-radius: 17px; transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), filter 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); transform: translateX(${questionType === 'both' ? '100%' : questionType === 'completion' ? '200%' : '0%'}); box-shadow: 0 4px 12px rgba(76, 175, 80, 0.6), 0 0 20px rgba(76, 175, 80, 0.3); filter: brightness(1.1);"></div>
                            <button data-toggle-type="reference" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(${questionType === 'reference' ? '1' : '0.95'})'" onclick="setQuestionType('reference');" style="position: relative; z-index: 1; padding: 8px; background: transparent; border: none; color: ${questionType === 'reference' ? 'white' : 'rgba(255, 255, 255, 0.5)'}; font-size: 0.8rem; font-weight: ${questionType === 'reference' ? '600' : '400'}; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); transform: scale(${questionType === 'reference' ? '1' : '0.95'});">
                                R→V
                            </button>
                            <button data-toggle-type="both" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(${questionType === 'both' ? '1' : '0.95'})'" onclick="setQuestionType('both');" style="position: relative; z-index: 1; padding: 8px; background: transparent; border: none; color: ${questionType === 'both' ? 'white' : 'rgba(255, 255, 255, 0.5)'}; font-size: 0.8rem; font-weight: ${questionType === 'both' ? '600' : '400'}; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); transform: scale(${questionType === 'both' ? '1' : '0.95'});">
                                Both
                            </button>
                            <button data-toggle-type="completion" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(${questionType === 'completion' ? '1' : '0.95'})'" onclick="setQuestionType('completion');" style="position: relative; z-index: 1; padding: 8px; background: transparent; border: none; color: ${questionType === 'completion' ? 'white' : 'rgba(255, 255, 255, 0.5)'}; font-size: 0.8rem; font-weight: ${questionType === 'completion' ? '600' : '400'}; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); transform: scale(${questionType === 'completion' ? '1' : '0.95'});">
                                V→R
                            </button>
                        </div>
                    </div>

                    <div style="background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 8px; padding: 8px; margin-bottom: 16px; position: relative;">
                        <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleThemesDropdown()">
                            <span style="color: #4caf50; font-size: 0.85rem; font-weight: 600;">${selectedThemesData.length} Theme${selectedThemesData.length !== 1 ? 's' : ''} Selected</span>
                            <span id="themesDropdownIcon" style="color: #4caf50; font-size: 1rem; transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); display: inline-block;">▼</span>
                        </div>
                        <div id="themesDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 8px; padding: 12px; background: rgba(42, 48, 80, 0.98); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 8px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4); z-index: 100; backdrop-filter: blur(10px);">
                            <div id="themesList" style="max-height: 280px; overflow-y: auto; padding-right: 6px; scrollbar-width: thin; scrollbar-color: rgba(76, 175, 80, 0.5) rgba(255, 255, 255, 0.1);">
                                ${allThemesHTML}
                            </div>
                        </div>
                    </div>
                `;

                // Insert Start Quiz button into fixed button container
                const buttonContainer = document.getElementById('quickStartButtonContainer');
                if (buttonContainer) {
                    buttonContainer.innerHTML = `
                        <button class="btn btn-primary start-quiz-btn" onclick="confirmQuickStart()" style="width: 100%; padding: 12px; font-size: 0.95rem;">
                            ⚡ Start Quiz Now
                        </button>
                    `;
                }

                modal.style.display = 'flex';

            } catch (error) {
                console.error('Error loading quick start preview:', error);
                container.innerHTML = `
                    <div class="empty-themes">
                        <div class="empty-themes-icon">❌</div>
                        <h3>Error Loading Preview</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="confirmQuickStart()">Start Anyway</button>
                    </div>
                `;
                modal.style.display = 'flex';
            }
        }

        function adjustTimeLimit(change) {
            const settings = SettingsManager.getSettings();
            const allowedTimes = [5, 10, 20];

            // Find current index in allowed times
            let currentIndex = allowedTimes.indexOf(settings.timeLimit);
            if (currentIndex === -1) {
                // If current value not in allowed list, default to first option
                currentIndex = 0;
            }

            // Move through allowed values, stop at boundaries
            let newIndex = currentIndex + change;
            if (newIndex >= allowedTimes.length) newIndex = allowedTimes.length - 1;
            if (newIndex < 0) newIndex = 0;

            const newTimeLimit = allowedTimes[newIndex];
            SettingsManager.saveSettings(newTimeLimit, settings.questionCount);

            // Update display
            const display = document.getElementById('timeLimitDisplay');
            if (display) {
                display.textContent = newTimeLimit + 's';
            }

            console.log(`⏱️ Time limit set to: ${newTimeLimit}s`);
        }

        function adjustQuestionCount(change) {
            const settings = SettingsManager.getSettings();
            const allowedCounts = [10, 20, 30];

            // Find current index in allowed counts
            let currentIndex = allowedCounts.indexOf(settings.questionCount);
            if (currentIndex === -1) {
                // If current value not in allowed list, default to first option
                currentIndex = 0;
            }

            // Move through allowed values, stop at boundaries
            let newIndex = currentIndex + change;
            if (newIndex >= allowedCounts.length) newIndex = allowedCounts.length - 1;
            if (newIndex < 0) newIndex = 0;

            const newQuestionCount = allowedCounts[newIndex];
            SettingsManager.saveSettings(settings.timeLimit, newQuestionCount);

            // Update display
            const display = document.getElementById('questionCountDisplay');
            if (display) {
                display.textContent = newQuestionCount;
            }

            console.log(`📝 Question count set to: ${newQuestionCount}`);
        }

        function confirmQuickStart() {
            const settings = SettingsManager.getSettings();
            const selectedThemes = SettingsManager.getSelectedThemes();

            SettingsManager.saveSettings(settings.timeLimit, settings.questionCount);
            SettingsManager.saveThemes(selectedThemes);

            console.log('Quick Start - Navigating to quiz.html');
            window.location.href = '/quiz.html';
        }

        function closeQuickStartModal(event) {
            if (event && event.target !== event.currentTarget) return;

            // Save current settings before closing (ensures everything is persisted)
            const settings = SettingsManager.getSettings();
            const selectedThemes = SettingsManager.getSelectedThemes();

            SettingsManager.saveSettings(settings.timeLimit, settings.questionCount);
            SettingsManager.saveThemes(selectedThemes);

            console.log('💾 Quick Start settings saved on modal close');

            const modal = document.getElementById('quickStartModal');
            modal.style.display = 'none';

            // Reset to single player tab when closing
            switchQuickStartTab('singleplayer');

            // Reset multiplayer view to main menu
            showMultiplayerView('main');
        }

        function switchQuickStartTab(tabName) {
            // Get all tabs and tab contents
            const tabs = document.querySelectorAll('#quickStartModal .modal-tab');
            const tabContents = document.querySelectorAll('#quickStartModal .tab-content');

            // Remove active class from all tabs and contents
            tabs.forEach(tab => tab.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            // Add active class to selected tab and content
            const selectedTab = tabName === 'multiplayer' ? tabs[1] : tabs[0];
            const selectedContent = document.getElementById(tabName + 'Tab');

            if (selectedTab) selectedTab.classList.add('active');
            if (selectedContent) selectedContent.classList.add('active');

            console.log(`🔀 Switched to ${tabName} tab`);
        }

        function openQuickStartModal() {
            // Load the single player tab content
            const settings = SettingsManager.getSettings();
            const selectedThemes = SettingsManager.getSelectedThemes();
            showQuickStartPreview(settings, selectedThemes);
        }

        // Multiplayer view switching within the modal
        function showMultiplayerView(viewName) {
            // Hide all multiplayer views
            const sections = [
                'multiplayerMainMenu',
                'multiplayerSearching',
                'multiplayerCreateRoom',
                'multiplayerJoinRoom',
                'multiplayerWaitingRoom'
            ];
            for (const id of sections) {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            }

            // Map view names to section IDs
            const map = {
                main: 'multiplayerMainMenu',
                searching: 'multiplayerSearching',
                createRoom: 'multiplayerCreateRoom',
                joinRoom: 'multiplayerJoinRoom',
                waitingRoom: 'multiplayerWaitingRoom',
            };
            const targetId = map[viewName] || 'multiplayerMainMenu';
            const target = document.getElementById(targetId);
            if (!target) return;

            // Set display based on section type
            target.style.display = (targetId === 'multiplayerWaitingRoom' || targetId === 'multiplayerMainMenu') ? 'flex' : 'block';

            // Execute view-specific actions
            if (viewName === 'searching') {
                // Start quick match
                if (!multiplayerManager.isConnected) {
                    multiplayerManager.connect();
                    setTimeout(() => multiplayerManager.findMatch(), 200);
                } else {
                    multiplayerManager.findMatch();
                }
            } else if (viewName === 'createRoom') {
                // Load themes for room creation
                loadThemesForRoomIntegrated();
            } else if (viewName === 'joinRoom') {
                // Focus on input
                setTimeout(() => {
                    const input = document.getElementById('roomCodeInputIntegrated');
                    if (input) input.focus();
                }, 50);
            }

            console.log(`🔀 Multiplayer view: ${viewName}`);
        }

        // Load themes for integrated room creation
        async function loadThemesForRoomIntegrated() {
            try {
                const response = await fetch('/api/themes');
                const data = await response.json();

                if (data.success && data.themes) {
                    const themeSelector = document.getElementById('themeSelector');
                    const userThemes = JSON.parse(localStorage.getItem('selectedThemes') || '[]');

                    // Filter to only show themes user has selected in settings
                    const userSelectedThemes = data.themes.filter(theme => userThemes.includes(theme.id));

                    if (userSelectedThemes.length === 0) {
                        themeSelector.innerHTML = '<div style="color: rgba(255,255,255,0.6); padding: 20px; text-align: center; font-size: 0.85rem;">No themes configured. Use Quick Start to select themes first.</div>';
                        return;
                    }

                    // Create checkbox items
                    const checkboxItems = userSelectedThemes.map(theme => {
                        const creatorTag = theme.created_by ? ` @${theme.created_by}` : '';
                        return `
                            <label class="theme-checkbox-item" data-theme-id="${theme.id}" style="display: flex; align-items: center; padding: 10px; margin: 4px 0; background: rgba(255, 255, 255, 0.05); border-radius: 8px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent;">
                                <input type="checkbox" value="${theme.id}" checked style="display: none;">
                                <span class="checkmark" style="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 5px; margin-right: 10px; background: rgba(76, 175, 80, 0.3); transition: all 0.2s; font-size: 0.75rem;">
                                    ✓
                                </span>
                                <span style="flex: 1; color: white; font-size: 0.85rem;">
                                    ${theme.name}${creatorTag} <span style="color: rgba(255,255,255,0.5); font-size: 0.75rem;">(${theme.question_count || 0})</span>
                                </span>
                            </label>
                        `;
                    }).join('');

                    themeSelector.innerHTML = checkboxItems;
                    updateThemeSelectionCountIntegrated();

                    // Add click handlers
                    const items = themeSelector.querySelectorAll('.theme-checkbox-item');
                    items.forEach(item => {
                        item.addEventListener('click', function() {
                            const checkbox = this.querySelector('input[type="checkbox"]');
                            const checkmark = this.querySelector('.checkmark');
                            const isChecked = checkbox.checked;

                            checkbox.checked = !isChecked;

                            if (!isChecked) {
                                this.style.borderColor = 'rgba(76, 175, 80, 0.5)';
                                checkmark.style.background = 'rgba(76, 175, 80, 0.3)';
                                checkmark.textContent = '✓';
                            } else {
                                this.style.borderColor = 'transparent';
                                checkmark.style.background = 'transparent';
                                checkmark.textContent = '';
                            }

                            updateThemeSelectionCountIntegrated();
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading themes:', error);
            }
        }

        function updateThemeSelectionCountIntegrated() {
            const checkboxes = document.querySelectorAll('#themeSelector input[type="checkbox"]:checked');
            const count = checkboxes.length;
            const countDisplay = document.getElementById('themeSelectionCount');
            if (countDisplay) {
                countDisplay.textContent = `(${count}/5 selected)`;
            }
        }

        // Confirm room creation from integrated view
        async function confirmCreateRoomIntegrated() {
            const selectedThemes = Array.from(document.querySelectorAll('#themeSelector input[type="checkbox"]:checked'))
                .map(cb => parseInt(cb.value));

            if (selectedThemes.length === 0) {
                showError('Please select at least one theme');
                return;
            }

            if (selectedThemes.length > 5) {
                showError('Please select at most 5 themes');
                return;
            }

            const hostPlaying = document.getElementById('hostPlayingCheckbox').checked;

            // Ensure connected
            if (!multiplayerManager.isConnected) {
                multiplayerManager.connect();
                await new Promise(resolve => setTimeout(resolve, 300));
            }

            multiplayerManager.hostIsPlaying = hostPlaying;

            // Send create room request
            multiplayerManager.send('create_room', {
                username: multiplayerManager.playerName,
                theme_ids: selectedThemes,
                question_count: 20,
                time_limit: 10,
                host_is_playing: hostPlaying
            });

            console.log('🏠 Creating room with themes:', selectedThemes, 'Host playing:', hostPlaying);

            // Don't close modal - the waiting room will show via WebSocket response within this modal
        }

        // Join room from integrated view
        async function joinRoomIntegrated() {
            const input = document.getElementById('roomCodeInputIntegrated');
            const roomCode = (input?.value || '').toUpperCase().trim();

            if (roomCode.length !== 6) {
                showError('Please enter a valid 6-character room code');
                return;
            }

            console.log(`[Integrated] Joining room: ${roomCode}`);

            // Ensure connected
            try {
                await multiplayerManager.ensureConnected();
            } catch (error) {
                console.error('[Integrated] Failed to connect:', error);
                showError('Connection failed. Please try again.');
                return;
            }

            // Send join request
            multiplayerManager.send('join_room', {
                room_code: roomCode,
                username: multiplayerManager.playerName
            });

            multiplayerManager.currentRoomCode = roomCode;
            multiplayerManager.isHost = false;

            // Don't close modal - waiting room will show via WebSocket response within this modal
        }

        // Show integrated waiting room
        function showIntegratedWaitingRoom(roomCode, isHost) {
            // Just show the waiting room view within the current multiplayer tab
            showMultiplayerView('waitingRoom');

            // Update title and room code
            document.getElementById('waitingRoomTitle').textContent = isHost ? '🏠 Private Room' : '🔓 Joined Room';
            document.getElementById('displayRoomCodeIntegrated').textContent = roomCode;

            // Show/hide spectating notice
            const spectatingNotice = document.getElementById('spectatingNotice');
            if (isHost && !multiplayerManager.hostIsPlaying) {
                spectatingNotice.style.display = 'block';
            } else {
                spectatingNotice.style.display = 'none';
            }

            // Update ready button
            const readyBtn = document.getElementById('readyBtnIntegrated');
            if (isHost) {
                readyBtn.disabled = true;
                readyBtn.textContent = 'Waiting for Players';
            } else {
                readyBtn.disabled = false;
                readyBtn.textContent = 'Ready';
            }

            console.log(`📍 Integrated waiting room shown: ${roomCode} (host: ${isHost})`);
        }

        // Update player list in integrated waiting room
        function updateIntegratedPlayerList(data) {
            const container = document.getElementById('playersContainerIntegrated');
            if (!container || !data.players) return;

            container.innerHTML = data.players.map(p => {
                const isSpectating = p.is_host && !p.is_playing;
                const statusIcon = isSpectating ? '👁️' : (p.is_ready ? '✓' : '○');
                const statusClass = p.is_ready ? 'ready' : '';
                const hostTag = p.is_host ? ' (Host)' : '';
                const spectatingTag = isSpectating ? ' - Spectating' : '';
                const youTag = p.player_id === multiplayerManager.playerId ? ' - You' : '';

                return `
                    <div class="player-slot" style="${isSpectating ? 'opacity: 0.6; font-style: italic;' : ''} padding: 10px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; display: flex; align-items: center; gap: 10px;">
                        <span class="player-status ${statusClass}" style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; background: ${p.is_ready ? 'rgba(76, 175, 80, 0.3)' : 'rgba(255, 255, 255, 0.1)'}; color: ${p.is_ready ? '#4caf50' : 'rgba(255, 255, 255, 0.5)'}; font-weight: bold;">
                            ${statusIcon}
                        </span>
                        <span style="color: white; font-size: 0.9rem;">@${p.username}${hostTag}${spectatingTag}${youTag}</span>
                    </div>
                `;
            }).join('');

            // Update ready button for host
            const btn = document.getElementById('readyBtnIntegrated');
            if (btn && multiplayerManager.isHost) {
                const playingPlayers = data.players.filter(p => p.is_playing);
                const readyPlayingPlayers = playingPlayers.filter(p => p.is_ready);

                const canStart = playingPlayers.length >= 2 &&
                                readyPlayingPlayers.length === playingPlayers.length;

                btn.disabled = !canStart;
                btn.textContent = canStart
                    ? 'Start Game'
                    : `Waiting (${readyPlayingPlayers.length}/${playingPlayers.length} ready)`;
            }
        }

        // Copy room code from integrated waiting room
        function copyRoomCodeIntegrated() {
            const roomCode = document.getElementById('displayRoomCodeIntegrated').textContent;
            navigator.clipboard.writeText(roomCode).then(() => {
                showSuccess('Room code copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showError('Failed to copy room code');
            });
        }

        // Toggle ready in integrated waiting room
        function toggleReadyIntegrated() {
            if (multiplayerManager.isHost) {
                multiplayerManager.startGame();
            } else {
                multiplayerManager.send('player_ready', { is_ready: true });
                const btn = document.getElementById('readyBtnIntegrated');
                if (btn) {
                    btn.textContent = 'Waiting...';
                    btn.disabled = true;
                }
            }
        }

        // Leave room from integrated waiting room
        function leaveRoomIntegrated() {
            multiplayerManager.leaveRoom();
            showMultiplayerView('main');
        }

        function toggleThemesDropdown() {
            const dropdown = document.getElementById('themesDropdown');
            const icon = document.getElementById('themesDropdownIcon');

            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                dropdown.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                dropdown.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function toggleQuickStartTheme(themeId, element) {
            // Get current selected themes
            let selectedThemes = SettingsManager.getSelectedThemes();

            // Toggle theme
            if (selectedThemes.includes(themeId)) {
                selectedThemes = selectedThemes.filter(id => id !== themeId);
            } else {
                selectedThemes.push(themeId);
            }

            // Save to localStorage
            SettingsManager.saveThemes(selectedThemes);

            // Update checkbox
            const checkbox = element.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;

            // Update background
            const isSelected = selectedThemes.includes(themeId);
            element.style.background = `rgba(255, 255, 255, ${isSelected ? '0.1' : '0.03'})`;
            element.onmouseout = () => {
                element.style.background = `rgba(255, 255, 255, ${isSelected ? '0.1' : '0.03'})`;
            };

            // Update count in header
            const headerSpan = document.querySelector('#quickStartContainer span[style*="color: #4caf50"]');
            if (headerSpan) {
                headerSpan.textContent = `${selectedThemes.length} Theme${selectedThemes.length !== 1 ? 's' : ''} Selected`;
            }

            console.log(`✅ Theme ${themeId} ${isSelected ? 'selected' : 'deselected'}`);
        }

        // ==============================
        // Multiplayer Start
        // ==============================
        function startMultiplayer() {
            // Open Quick Start modal with multiplayer tab
            openQuickStartModal();
            switchQuickStartTab('multiplayer');

            // Connect to WebSocket if not connected
            if (!multiplayerManager.isConnected) {
                multiplayerManager.connect();
            }
        }

        // ==============================
        // Challenges placeholder
        // ==============================
        function viewChallenges() {
            location.href = '/challenges.html';
        }

        // ==============================
        // Page Init
        // ==============================
        async function loadPreferencesFromDatabase() {
            const token = localStorage.getItem('token');
            if (!token) {
                // Guest user - use localStorage only
                return;
            }

            try {
                const response = await fetch('/api/auth/preferences', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        // Update localStorage with database values
                        localStorage.setItem('selectedThemes', JSON.stringify(data.selected_themes || []));
                        localStorage.setItem('quizSettings', JSON.stringify({
                            timeLimit: data.quiz_time_limit || 10,
                            questionCount: data.quiz_question_count || 10
                        }));

                        console.log('✅ Loaded preferences from database:', data);

                        // Update UI badges to reflect loaded preferences
                        SettingsManager.updateBadges();
                    }
                }
            } catch (error) {
                console.warn('Failed to load preferences from database, using localStorage:', error);
            }
        }

        window.addEventListener('DOMContentLoaded', async () => {
            // Debug: Check token on page load
            console.log('🏠 Index.html loaded');
            console.log('🔑 Token check:', {
                token: localStorage.getItem('token'),
                user: localStorage.getItem('user'),
                tokenLength: localStorage.getItem('token')?.length || 0
            });

            createParticles();
            updateLoginUI();

            // Load from database FIRST, then load stats
            await loadPreferencesFromDatabase();

            const playerName = localStorage.getItem('playerName');
            if (!playerName) {
                openLoginModal();
            }

            // Now load stats with correct data from database
            loadStats();
            setInterval(loadStats, 30000);
        });

    </script>
</body>
</html>